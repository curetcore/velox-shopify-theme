{% comment %}
  Velox Cart Drawer
  Carrito lateral con items y totales.

  Uso:
  {% render 'cart-drawer' %}
{% endcomment %}

{%- comment -%} Overlay {%- endcomment -%}
<div
  id="cart-overlay"
  class="tw-fixed tw-inset-0 tw-bg-black/50 tw-z-40 tw-opacity-0 tw-invisible tw-transition-all tw-duration-300"
  data-cart-overlay
  aria-hidden="true"
></div>

{%- comment -%} Cart drawer {%- endcomment -%}
<div
  id="cart-drawer"
  class="tw-fixed tw-inset-y-0 tw-right-0 tw-w-full tw-max-w-md tw-bg-white tw-z-50 tw-transform tw-translate-x-full tw-transition-transform tw-duration-300 tw-ease-in-out tw-flex tw-flex-col"
  data-cart-drawer
  role="dialog"
  aria-modal="true"
  aria-label="{{ 'cart.general.title' | t | default: 'Carrito' }}"
>
  {%- comment -%} Header {%- endcomment -%}
  <div class="tw-flex tw-items-center tw-justify-between tw-px-4 tw-py-4 tw-border-b tw-border-velox-100">
    <h2 class="tw-text-lg tw-font-semibold tw-text-velox-900">
      {{ 'cart.general.title' | t | default: 'Carrito' }}
      <span class="tw-text-velox-500 tw-font-normal" data-cart-count-text>
        ({{ cart.item_count }} {{ cart.item_count | pluralize: 'item', 'items' }})
      </span>
    </h2>
    <button
      type="button"
      class="tw-p-2 tw--mr-2 tw-text-velox-500 hover:tw-text-velox-900 tw-transition-colors"
      data-cart-close
      aria-label="{{ 'general.accessibility.close' | t | default: 'Cerrar' }}"
    >
      {% render 'icon', name: 'x', class: 'tw-w-6 tw-h-6' %}
    </button>
  </div>

  {%- comment -%} Free shipping progress with checkpoints {%- endcomment -%}
  {% assign free_shipping_threshold = settings.free_shipping_threshold | default: 2000 | times: 100 %}
  {% assign show_free_shipping = settings.show_free_shipping_bar | default: true %}

  {% if show_free_shipping and free_shipping_threshold > 0 %}
    {% assign amount_remaining = free_shipping_threshold | minus: cart.total_price %}
    {% assign progress_percentage = cart.total_price | times: 100.0 | divided_by: free_shipping_threshold %}
    {% if progress_percentage > 100 %}{% assign progress_percentage = 100 %}{% endif %}

    <div
      class="tw-px-4 tw-py-3 tw-bg-velox-50 tw-border-b tw-border-velox-100"
      data-free-shipping-bar
      data-free-shipping-threshold="{{ free_shipping_threshold }}"
      data-free-shipping-success="{{ 'cart.general.free_shipping_achieved' | t | default: 'Â¡EnvÃ­o gratis desbloqueado!' }}"
      data-free-shipping-remaining="{{ 'cart.general.free_shipping_remaining' | t | default: 'Te faltan {amount} para envÃ­o gratis' }}"
    >
      <p class="tw-text-sm tw-mb-2" data-shipping-message>
        {% if amount_remaining > 0 %}
          <span class="tw-text-velox-700">
            {{ 'cart.general.free_shipping_remaining' | t: amount: amount_remaining | money | default: 'Te faltan ' | append: amount_remaining | money | append: ' para envÃ­o gratis' }}
          </span>
        {% else %}
          <span class="tw-text-green-700 tw-font-medium">
            ðŸŽ‰ {{ 'cart.general.free_shipping_achieved' | t | default: 'Â¡EnvÃ­o gratis desbloqueado!' }}
          </span>
        {% endif %}
      </p>
      {%- comment -%} Progress bar with visual checkpoints {%- endcomment -%}
      <div class="tw-relative">
        <div class="tw-w-full tw-h-2 tw-bg-velox-200 tw-rounded-full tw-overflow-hidden">
          <div
            class="tw-h-full {% if progress_percentage >= 100 %}tw-bg-green-500{% else %}tw-bg-accent{% endif %} tw-rounded-full tw-transition-all tw-duration-500 tw-ease-out"
            style="width: {{ progress_percentage }}%;"
            data-shipping-progress
          ></div>
        </div>
        {%- comment -%} Checkpoints at 25%, 50%, 75%, 100% {%- endcomment -%}
        <div class="tw-absolute tw-inset-0 tw-flex tw-justify-between tw-items-center tw-pointer-events-none">
          {% for i in (1..4) %}
            {% assign checkpoint_percentage = i | times: 25 %}
            {% assign checkpoint_value = free_shipping_threshold | times: checkpoint_percentage | divided_by: 100 %}
            {% assign is_reached = false %}
            {% if cart.total_price >= checkpoint_value %}{% assign is_reached = true %}{% endif %}
            <div class="tw-flex tw-flex-col tw-items-center" style="position: absolute; left: {{ checkpoint_percentage }}%; transform: translateX(-50%);">
              <div class="tw-w-3 tw-h-3 tw-rounded-full tw-border-2 {% if is_reached %}tw-bg-green-500 tw-border-green-500{% else %}tw-bg-white tw-border-velox-300{% endif %} tw-transition-colors tw-duration-300"></div>
              {% if i == 4 %}
                <span class="tw-text-[10px] tw-text-velox-500 tw-mt-1">ðŸšš</span>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  {% endif %}


  {%- comment -%} Cart items {%- endcomment -%}
  <div class="tw-flex-1 tw-overflow-y-auto tw-px-4 tw-py-4" data-cart-items>
    {% if cart.item_count > 0 %}
      <ul class="tw-space-y-4">
        {% for item in cart.items %}
          <li class="tw-flex tw-gap-4" data-cart-item="{{ item.key }}">
            {%- comment -%} Product image {%- endcomment -%}
            <a href="{{ item.url }}" class="tw-w-20 tw-h-24 tw-bg-velox-100 tw-rounded-md tw-overflow-hidden tw-flex-shrink-0">
              {% if item.image %}
                {{ item.image | image_url: width: 160 | image_tag:
                  class: 'tw-w-full tw-h-full tw-object-cover',
                  alt: item.title,
                  loading: 'lazy'
                }}
              {% else %}
                <div class="tw-w-full tw-h-full tw-flex tw-items-center tw-justify-center">
                  {% render 'icon', name: 'eye', class: 'tw-w-8 tw-h-8 tw-text-velox-300' %}
                </div>
              {% endif %}
            </a>

            {%- comment -%} Product details {%- endcomment -%}
            <div class="tw-flex-1 tw-min-w-0">
              <a href="{{ item.url }}" class="tw-text-sm tw-font-medium tw-text-velox-900 hover:tw-underline tw-line-clamp-2">
                {{ item.product.title }}
              </a>

              {% if item.variant.title != 'Default Title' %}
                <p class="tw-text-xs tw-text-velox-500 tw-mt-0.5">
                  {{ item.variant.title }}
                </p>
              {% endif %}

              {%- comment -%} Price {%- endcomment -%}
              <div class="tw-mt-1">
                {% if item.original_line_price != item.final_line_price %}
                  <span class="tw-text-sm tw-font-medium tw-text-accent" data-item-price="{{ item.key }}">{{ item.final_line_price | money }}</span>
                  <span class="tw-text-xs tw-text-velox-400 tw-line-through tw-ml-1">{{ item.original_line_price | money }}</span>
                {% else %}
                  <span class="tw-text-sm tw-font-medium tw-text-velox-900" data-item-price="{{ item.key }}">{{ item.final_line_price | money }}</span>
                {% endif %}
              </div>

              {%- comment -%} Quantity controls {%- endcomment -%}
              <div class="tw-flex tw-items-center tw-gap-3 tw-mt-2">
                <div class="tw-flex tw-items-center tw-border tw-border-velox-200 tw-rounded-md">
                  <button
                    type="button"
                    class="tw-p-1.5 tw-text-velox-500 hover:tw-text-velox-900 tw-transition-colors disabled:tw-opacity-50"
                    data-quantity-minus="{{ item.key }}"
                    aria-label="{{ 'cart.general.decrease' | t | default: 'Disminuir cantidad' }}"
                    {% if item.quantity <= 1 %}disabled{% endif %}
                  >
                    {% render 'icon', name: 'minus', class: 'tw-w-4 tw-h-4' %}
                  </button>
                  <input
                    type="number"
                    value="{{ item.quantity }}"
                    min="1"
                    class="tw-w-10 tw-text-center tw-text-sm tw-border-0 focus:tw-outline-none focus:tw-ring-0"
                    data-quantity-input="{{ item.key }}"
                    aria-label="{{ 'cart.general.quantity' | t | default: 'Cantidad' }}"
                  >
                  <button
                    type="button"
                    class="tw-p-1.5 tw-text-velox-500 hover:tw-text-velox-900 tw-transition-colors"
                    data-quantity-plus="{{ item.key }}"
                    aria-label="{{ 'cart.general.increase' | t | default: 'Aumentar cantidad' }}"
                  >
                    {% render 'icon', name: 'plus', class: 'tw-w-4 tw-h-4' %}
                  </button>
                </div>

                <button
                  type="button"
                  class="tw-text-velox-400 hover:tw-text-red-500 tw-transition-colors"
                  data-remove-item="{{ item.key }}"
                  aria-label="{{ 'cart.general.remove' | t | default: 'Eliminar' }}"
                >
                  {% render 'icon', name: 'trash', class: 'tw-w-4 tw-h-4' %}
                </button>
              </div>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      {%- comment -%} Empty cart {%- endcomment -%}
      <div class="tw-flex tw-flex-col tw-items-center tw-justify-center tw-py-12 tw-text-center" data-cart-empty>
        {% render 'icon', name: 'cart', class: 'tw-w-16 tw-h-16 tw-text-velox-200 tw-mb-4' %}
        <p class="tw-text-velox-500 tw-mb-4">
          {{ 'cart.general.empty' | t | default: 'Tu carrito estÃ¡ vacÃ­o' }}
        </p>
        <button
          type="button"
          class="tw-btn tw-btn-primary"
          data-cart-close
        >
          {{ 'cart.general.continue_shopping' | t | default: 'Seguir comprando' }}
        </button>
      </div>
    {% endif %}
  </div>

  {%- comment -%} Cart Upsells {%- endcomment -%}
  {% assign show_upsells = settings.show_cart_upsells | default: true %}
  {% if show_upsells and cart.item_count > 0 %}
    <div class="tw-px-4 tw-py-4 tw-border-t tw-border-velox-100" data-cart-upsells>
      <h3 class="tw-text-sm tw-font-semibold tw-text-velox-900 tw-mb-3">
        {{ settings.cart_upsells_heading | default: 'You might also like' }}
      </h3>
      <div class="tw-flex tw-gap-3 tw-overflow-x-auto tw-pb-2 tw-scrollbar-hide" data-upsells-container>
        {%- comment -%} Loading skeleton {%- endcomment -%}
        <div class="tw-flex tw-gap-3" data-upsells-loading>
          {% for i in (1..4) %}
            <div class="tw-flex-shrink-0 tw-w-24 tw-animate-pulse">
              <div class="tw-w-24 tw-h-24 tw-bg-velox-100 tw-rounded-md tw-mb-2"></div>
              <div class="tw-h-3 tw-bg-velox-100 tw-rounded tw-mb-1"></div>
              <div class="tw-h-3 tw-bg-velox-100 tw-rounded tw-w-2/3"></div>
            </div>
          {% endfor %}
        </div>
        {%- comment -%} Products will be loaded via JS {%- endcomment -%}
        <div class="tw-hidden tw-flex tw-gap-3" data-upsells-products></div>
      </div>
    </div>
  {% endif %}

  {%- comment -%} Footer con totales y checkout {%- endcomment -%}
  {% if cart.item_count > 0 %}
    <div class="tw-border-t tw-border-velox-100 tw-px-4 tw-py-4 tw-space-y-4 tw-bg-white" data-cart-footer>
      {%- comment -%} Cart note {%- endcomment -%}
      <details class="tw-group">
        <summary class="tw-flex tw-items-center tw-justify-between tw-cursor-pointer tw-text-sm tw-text-velox-600 hover:tw-text-velox-900">
          {{ 'cart.general.note' | t | default: 'AÃ±adir nota al pedido' }}
          {% render 'icon', name: 'chevron-down', class: 'tw-w-4 tw-h-4 tw-transition-transform group-open:tw-rotate-180' %}
        </summary>
        <textarea
          name="note"
          class="tw-mt-2 tw-w-full tw-px-3 tw-py-2 tw-text-sm tw-border tw-border-velox-200 tw-rounded-md focus:tw-outline-none focus:tw-ring-1 focus:tw-ring-velox-900"
          rows="2"
          placeholder="{{ 'cart.general.note_placeholder' | t | default: 'Instrucciones especiales...' }}"
          data-cart-note
        >{{ cart.note }}</textarea>
      </details>

      {%- comment -%} Subtotal {%- endcomment -%}
      <div class="tw-flex tw-items-center tw-justify-between tw-text-base">
        <span class="tw-text-velox-600">{{ 'cart.general.subtotal' | t | default: 'Subtotal' }}</span>
        <span class="tw-font-semibold tw-text-velox-900" data-cart-subtotal>{{ cart.total_price | money }}</span>
      </div>

      <p class="tw-text-xs tw-text-velox-500">
        {{ 'cart.general.shipping_at_checkout' | t | default: 'Impuestos y envÃ­o calculados en el checkout' }}
      </p>

      {%- comment -%} Checkout button {%- endcomment -%}
      <a
        href="{{ routes.cart_url }}"
        class="tw-btn tw-btn-accent tw-w-full tw-text-center"
      >
        {{ 'cart.general.checkout' | t | default: 'Finalizar compra' }}
      </a>

      {%- comment -%} Continue shopping {%- endcomment -%}
      <button
        type="button"
        class="tw-w-full tw-text-center tw-text-sm tw-text-velox-600 hover:tw-text-velox-900 tw-underline tw-underline-offset-2"
        data-cart-close
      >
        {{ 'cart.general.continue_shopping' | t | default: 'Seguir comprando' }}
      </button>
    </div>
  {% endif %}
</div>
