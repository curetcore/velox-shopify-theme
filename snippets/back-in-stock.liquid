{% comment %}
  Back in Stock Alert
  Shows email signup form when product is sold out
  Works with Klaviyo, Mailchimp, or custom integrations

  Uso: {% render 'back-in-stock', product: product, variant: variant %}
{% endcomment %}

{% liquid
  assign current_variant = variant | default: product.selected_or_first_available_variant
  assign show_form = false
  unless current_variant.available
    assign show_form = true
  endunless
%}

{% if show_form %}
<div 
  class="back-in-stock tw-mt-4 tw-p-4 tw-bg-velox-50 tw-rounded-lg tw-border tw-border-velox-200"
  data-back-in-stock
  data-product-id="{{ product.id }}"
  data-variant-id="{{ current_variant.id }}"
>
  <div class="tw-text-center">
    <p class="tw-text-velox-700 tw-font-medium tw-mb-2">
      {{ 'products.product.sold_out' | t | default: 'Sold Out' }}
    </p>
    <p class="tw-text-sm tw-text-velox-600 tw-mb-4">
      {{ 'products.product.notify_when_available' | t | default: 'Get notified when this product is back in stock.' }}
    </p>

    {%- comment -%} Email Form {%- endcomment -%}
    <form 
      class="back-in-stock-form"
      data-back-in-stock-form
    >
      <div class="tw-flex tw-gap-2">
        <input
          type="email"
          name="email"
          required
          placeholder="{{ 'general.newsletter.email_placeholder' | t | default: 'Enter your email' }}"
          class="tw-flex-1 tw-px-4 tw-py-2.5 tw-border tw-border-velox-200 tw-rounded-lg focus:tw-outline-none focus:tw-ring-2 focus:tw-ring-accent/50 focus:tw-border-accent tw-text-sm"
          data-back-in-stock-email
        >
        <button
          type="submit"
          class="tw-px-4 tw-py-2.5 tw-bg-velox-900 tw-text-white tw-font-medium tw-rounded-lg hover:tw-bg-velox-800 tw-transition-colors tw-text-sm tw-whitespace-nowrap"
          data-back-in-stock-submit
        >
          {{ 'products.product.notify_me' | t | default: 'Notify Me' }}
        </button>
      </div>

      {%- comment -%} Hidden fields for integration {%- endcomment -%}
      <input type="hidden" name="product_id" value="{{ product.id }}">
      <input type="hidden" name="variant_id" value="{{ current_variant.id }}">
      <input type="hidden" name="product_title" value="{{ product.title }}">
      <input type="hidden" name="variant_title" value="{{ current_variant.title }}">
    </form>

    {%- comment -%} Success/Error messages {%- endcomment -%}
    <div class="tw-hidden tw-mt-3 tw-text-sm tw-text-green-600" data-back-in-stock-success>
      âœ“ {{ 'products.product.notify_success' | t | default: "We'll notify you when this item is back in stock!" }}
    </div>
    <div class="tw-hidden tw-mt-3 tw-text-sm tw-text-red-600" data-back-in-stock-error>
      {{ 'products.product.notify_error' | t | default: 'Something went wrong. Please try again.' }}
    </div>
  </div>
</div>

<script>
(function() {
  const form = document.querySelector('[data-back-in-stock-form]');
  if (!form) return;

  const submitBtn = form.querySelector('[data-back-in-stock-submit]');
  const emailInput = form.querySelector('[data-back-in-stock-email]');
  const successMsg = document.querySelector('[data-back-in-stock-success]');
  const errorMsg = document.querySelector('[data-back-in-stock-error]');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const email = emailInput.value.trim();
    if (!email) return;

    // Show loading
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = '...';

    try {
      // Check for Klaviyo
      if (window._learnq) {
        window._learnq.push(['identify', { '$email': email }]);
        window._learnq.push(['track', 'Back In Stock Subscribed', {
          ProductID: form.querySelector('[name="product_id"]').value,
          VariantID: form.querySelector('[name="variant_id"]').value,
          ProductTitle: form.querySelector('[name="product_title"]').value,
          VariantTitle: form.querySelector('[name="variant_title"]').value
        }]);
      }

      // Store locally as fallback
      const subscriptions = JSON.parse(localStorage.getItem('velox_back_in_stock') || '[]');
      subscriptions.push({
        email,
        product_id: form.querySelector('[name="product_id"]').value,
        variant_id: form.querySelector('[name="variant_id"]').value,
        timestamp: new Date().toISOString()
      });
      localStorage.setItem('velox_back_in_stock', JSON.stringify(subscriptions));

      // Show success
      form.classList.add('tw-hidden');
      successMsg.classList.remove('tw-hidden');
      errorMsg.classList.add('tw-hidden');

    } catch (error) {
      console.error('Back in stock error:', error);
      errorMsg.classList.remove('tw-hidden');
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
    }
  });
})();
</script>
{% endif %}
