{% comment %}
  Velox Theme - Predictive Search Component
  Componente de búsqueda predictiva con resultados instantáneos

  Uso:
  {% render 'predictive-search' %}

  Requiere que el header tenga un contenedor con id="predictive-search-results"
{% endcomment %}

<div id="predictive-search" class="velox-predictive" data-predictive-search>
  <form action="{{ routes.search_url }}" method="get" role="search" class="velox-predictive__form">
    <div class="velox-predictive__input-wrapper">
      <svg class="velox-predictive__input-icon" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
      </svg>
      <input
        type="search"
        id="predictive-search-input"
        name="q"
        placeholder="{{ 'general.search.placeholder' | t }}"
        class="velox-predictive__input"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="off"
        spellcheck="false"
        aria-label="{{ 'general.search.search' | t }}"
        aria-owns="predictive-search-results"
        aria-expanded="false"
        aria-haspopup="listbox"
        data-predictive-search-input
      >
      <button type="button" class="velox-predictive__clear" data-predictive-search-clear hidden aria-label="{{ 'general.accessibility.close' | t }}">
        <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
        </svg>
      </button>
      <div class="velox-predictive__loading" data-predictive-search-loading hidden>
        <svg class="velox-predictive__spinner" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10" stroke-opacity="0.25"></circle>
          <path d="M12 2a10 10 0 0 1 10 10" stroke-linecap="round"></path>
        </svg>
      </div>
    </div>
  </form>

  <div id="predictive-search-results" class="velox-predictive__results" role="listbox" data-predictive-search-results hidden>
    {%- comment %} Los resultados se cargan via AJAX {% endcomment -%}
  </div>
</div>

<script>
  (function() {
    const PREDICTIVE_SEARCH_API = '/search/suggest.json';
    const DEBOUNCE_DELAY = 300;
    const MIN_CHARS = 2;

    class PredictiveSearch {
      constructor(container) {
        this.container = container;
        this.input = container.querySelector('[data-predictive-search-input]');
        this.results = container.querySelector('[data-predictive-search-results]');
        this.clearBtn = container.querySelector('[data-predictive-search-clear]');
        this.loading = container.querySelector('[data-predictive-search-loading]');
        this.debounceTimer = null;
        this.abortController = null;

        this.bindEvents();
      }

      bindEvents() {
        this.input.addEventListener('input', this.onInput.bind(this));
        this.input.addEventListener('focus', this.onFocus.bind(this));
        this.clearBtn.addEventListener('click', this.onClear.bind(this));
        document.addEventListener('click', this.onClickOutside.bind(this));
        this.input.addEventListener('keydown', this.onKeydown.bind(this));
      }

      onInput(e) {
        const query = e.target.value.trim();

        // Mostrar/ocultar botón clear
        this.clearBtn.hidden = query.length === 0;

        // Cancelar búsqueda anterior
        clearTimeout(this.debounceTimer);
        if (this.abortController) {
          this.abortController.abort();
        }

        if (query.length < MIN_CHARS) {
          this.hideResults();
          return;
        }

        // Debounce
        this.debounceTimer = setTimeout(() => {
          this.search(query);
        }, DEBOUNCE_DELAY);
      }

      onFocus() {
        if (this.input.value.trim().length >= MIN_CHARS && this.results.innerHTML.trim()) {
          this.showResults();
        }
      }

      onClear() {
        this.input.value = '';
        this.clearBtn.hidden = true;
        this.hideResults();
        this.input.focus();
      }

      onClickOutside(e) {
        if (!this.container.contains(e.target)) {
          this.hideResults();
        }
      }

      onKeydown(e) {
        if (e.key === 'Escape') {
          this.hideResults();
          this.input.blur();
        }
      }

      async search(query) {
        this.showLoading();

        try {
          this.abortController = new AbortController();

          const params = new URLSearchParams({
            q: query,
            resources: JSON.stringify({
              type: ['product', 'article', 'page'],
              limit: 4,
              options: {
                unavailable_products: 'last',
                fields: ['title', 'product_type', 'variants.title', 'body']
              }
            })
          });

          const response = await fetch(`${PREDICTIVE_SEARCH_API}?${params}`, {
            signal: this.abortController.signal
          });

          if (!response.ok) throw new Error('Search failed');

          const data = await response.json();
          this.renderResults(data.resources.results, query);
        } catch (error) {
          if (error.name !== 'AbortError') {
            console.error('Predictive search error:', error);
            this.hideResults();
          }
        } finally {
          this.hideLoading();
        }
      }

      renderResults(results, query) {
        const { products = [], articles = [], pages = [] } = results;
        const hasResults = products.length || articles.length || pages.length;

        if (!hasResults) {
          this.results.innerHTML = `
            <div class="velox-predictive__no-results">
              <p>{{ 'general.search.no_results' | t }}</p>
            </div>
          `;
          this.showResults();
          return;
        }

        let html = '';

        // Productos
        if (products.length) {
          html += `
            <div class="velox-predictive__group">
              <h3 class="velox-predictive__group-title">{{ 'search.products' | t }}</h3>
              <ul class="velox-predictive__list" role="listbox">
          `;
          products.forEach(product => {
            const image = product.image || product.featured_image?.url || '';
            const price = this.formatMoney(product.price);
            html += `
              <li role="option">
                <a href="${product.url}" class="velox-predictive__item">
                  <div class="velox-predictive__item-image">
                    ${image ? `<img src="${image}&width=100" alt="" loading="lazy">` : `
                      <svg fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
                      </svg>
                    `}
                  </div>
                  <div class="velox-predictive__item-content">
                    <span class="velox-predictive__item-title">${this.highlightQuery(product.title, query)}</span>
                    <span class="velox-predictive__item-price">${price}</span>
                  </div>
                </a>
              </li>
            `;
          });
          html += `</ul></div>`;
        }

        // Artículos
        if (articles.length) {
          html += `
            <div class="velox-predictive__group">
              <h3 class="velox-predictive__group-title">{{ 'search.articles' | t }}</h3>
              <ul class="velox-predictive__list" role="listbox">
          `;
          articles.forEach(article => {
            html += `
              <li role="option">
                <a href="${article.url}" class="velox-predictive__item velox-predictive__item--article">
                  <svg class="velox-predictive__item-icon" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
                  </svg>
                  <span class="velox-predictive__item-title">${this.highlightQuery(article.title, query)}</span>
                </a>
              </li>
            `;
          });
          html += `</ul></div>`;
        }

        // Páginas
        if (pages.length) {
          html += `
            <div class="velox-predictive__group">
              <h3 class="velox-predictive__group-title">{{ 'search.pages' | t }}</h3>
              <ul class="velox-predictive__list" role="listbox">
          `;
          pages.forEach(page => {
            html += `
              <li role="option">
                <a href="${page.url}" class="velox-predictive__item velox-predictive__item--page">
                  <svg class="velox-predictive__item-icon" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
                  </svg>
                  <span class="velox-predictive__item-title">${this.highlightQuery(page.title, query)}</span>
                </a>
              </li>
            `;
          });
          html += `</ul></div>`;
        }

        // Ver todos los resultados
        html += `
          <a href="{{ routes.search_url }}?q=${encodeURIComponent(query)}" class="velox-predictive__view-all">
            {{ 'general.search.view_all' | t }}
            <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />
            </svg>
          </a>
        `;

        this.results.innerHTML = html;
        this.showResults();
      }

      highlightQuery(text, query) {
        if (!query) return text;
        const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
        return text.replace(regex, '<mark>$1</mark>');
      }

      formatMoney(cents) {
        const amount = (cents / 100).toFixed(2);
        return Shopify.currency.active + ' ' + amount;
      }

      showResults() {
        this.results.hidden = false;
        this.input.setAttribute('aria-expanded', 'true');
      }

      hideResults() {
        this.results.hidden = true;
        this.input.setAttribute('aria-expanded', 'false');
      }

      showLoading() {
        this.loading.hidden = false;
      }

      hideLoading() {
        this.loading.hidden = true;
      }
    }

    // Inicializar cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', () => {
      const containers = document.querySelectorAll('[data-predictive-search]');
      containers.forEach(container => new PredictiveSearch(container));
    });
  })();
</script>

{% style %}
  /* ===========================================
     Predictive Search - Estilos
     =========================================== */

  .velox-predictive {
    position: relative;
    --predictive-accent: var(--color-accent, #4f46e5);
  }

  .velox-predictive__form {
    position: relative;
  }

  .velox-predictive__input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
  }

  .velox-predictive__input-icon {
    position: absolute;
    left: 0.875rem;
    width: 1.25rem;
    height: 1.25rem;
    color: #9ca3af;
    pointer-events: none;
  }

  .velox-predictive__input {
    width: 100%;
    padding: 0.625rem 3rem 0.625rem 2.75rem;
    font-size: 0.875rem;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    background: #ffffff;
    color: #111827;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }

  .velox-predictive__input:focus {
    outline: none;
    border-color: var(--predictive-accent);
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
  }

  .velox-predictive__input::placeholder {
    color: #9ca3af;
  }

  .velox-predictive__clear,
  .velox-predictive__loading {
    position: absolute;
    right: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .velox-predictive__clear {
    padding: 0.25rem;
    background: none;
    border: none;
    cursor: pointer;
    color: #9ca3af;
    transition: color 0.2s ease;
  }

  .velox-predictive__clear:hover {
    color: #6b7280;
  }

  .velox-predictive__clear svg {
    width: 1.125rem;
    height: 1.125rem;
  }

  .velox-predictive__loading {
    pointer-events: none;
  }

  .velox-predictive__spinner {
    width: 1.25rem;
    height: 1.25rem;
    color: var(--predictive-accent);
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Resultados */
  .velox-predictive__results {
    position: absolute;
    top: calc(100% + 0.5rem);
    left: 0;
    right: 0;
    z-index: 50;
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    max-height: 28rem;
    overflow-y: auto;
  }

  .velox-predictive__no-results {
    padding: 2rem 1rem;
    text-align: center;
    color: #6b7280;
    font-size: 0.875rem;
  }

  .velox-predictive__group {
    padding: 0.75rem 0;
    border-bottom: 1px solid #f3f4f6;
  }

  .velox-predictive__group:last-of-type {
    border-bottom: none;
  }

  .velox-predictive__group-title {
    font-size: 0.6875rem;
    font-weight: 600;
    color: #9ca3af;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 0 0 0.5rem;
    padding: 0 1rem;
  }

  .velox-predictive__list {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .velox-predictive__item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 1rem;
    text-decoration: none;
    color: #111827;
    transition: background 0.15s ease;
  }

  .velox-predictive__item:hover {
    background: #f9fafb;
  }

  .velox-predictive__item-image {
    flex-shrink: 0;
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 0.375rem;
    overflow: hidden;
    background: #f3f4f6;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #9ca3af;
  }

  .velox-predictive__item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .velox-predictive__item-image svg {
    width: 1.25rem;
    height: 1.25rem;
  }

  .velox-predictive__item-icon {
    flex-shrink: 0;
    width: 1.25rem;
    height: 1.25rem;
    color: #9ca3af;
  }

  .velox-predictive__item-content {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }

  .velox-predictive__item-title {
    font-size: 0.875rem;
    font-weight: 500;
    color: #111827;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .velox-predictive__item-title mark {
    background: rgba(79, 70, 229, 0.15);
    color: var(--predictive-accent);
    padding: 0 0.125rem;
    border-radius: 0.125rem;
  }

  .velox-predictive__item-price {
    font-size: 0.75rem;
    color: #6b7280;
  }

  .velox-predictive__view-all {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--predictive-accent);
    text-decoration: none;
    background: #f9fafb;
    border-top: 1px solid #f3f4f6;
    transition: background 0.15s ease;
  }

  .velox-predictive__view-all:hover {
    background: #f3f4f6;
  }

  .velox-predictive__view-all svg {
    width: 1rem;
    height: 1rem;
  }

  /* ===========================================
     Responsive
     =========================================== */

  @media (min-width: 640px) {
    .velox-predictive__results {
      min-width: 24rem;
    }
  }
{% endstyle %}
