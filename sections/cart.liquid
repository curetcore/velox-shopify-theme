{% comment %}
  Velox Cart Section
  Diseño profesional basado en Tailwind Plus.
  CSS responsivo nativo (no depende de clases Tailwind compiladas).
{% endcomment %}

{% liquid
  assign layout_style = section.settings.layout_style
  assign show_free_shipping = section.settings.show_free_shipping
  assign free_shipping_threshold = section.settings.free_shipping_threshold | times: 100
  assign show_cart_note = section.settings.show_cart_note
  assign show_continue_shopping = section.settings.show_continue_shopping
  assign color_scheme = section.settings.color_scheme

  if free_shipping_threshold > 0
    assign amount_remaining = free_shipping_threshold | minus: cart.total_price
    assign progress_percentage = cart.total_price | times: 100 | divided_by: free_shipping_threshold
    if progress_percentage > 100
      assign progress_percentage = 100
    endif
  endif
%}

{% style %}
  /* ========== CART BASE STYLES ========== */
  .velox-cart {
    background-color: #ffffff;
    min-height: 80vh;
  }

  .velox-cart--dark {
    background-color: #111827;
    color: #ffffff;
  }

  .velox-cart-container {
    max-width: 80rem;
    margin: 0 auto;
    padding: 2rem 1rem 6rem;
  }

  @media (min-width: 640px) {
    .velox-cart-container {
      padding: 2.5rem 1.5rem 6rem;
    }
  }

  @media (min-width: 1024px) {
    .velox-cart-container {
      padding: 4rem 2rem 6rem;
    }
  }

  /* ========== CART HEADER ========== */
  .velox-cart-header {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    margin-bottom: 2rem;
  }

  @media (min-width: 640px) {
    .velox-cart-header {
      margin-bottom: 3rem;
    }
  }

  .velox-cart-title {
    font-size: 1.875rem;
    font-weight: 700;
    letter-spacing: -0.025em;
    color: #111827;
  }

  @media (min-width: 640px) {
    .velox-cart-title {
      font-size: 2.25rem;
    }
  }

  .velox-cart--dark .velox-cart-title {
    color: #ffffff;
  }

  .velox-cart-continue {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.875rem;
    color: #6b7280;
    text-decoration: none;
    transition: color 0.15s;
  }

  .velox-cart-continue:hover {
    color: #111827;
  }

  .velox-cart--dark .velox-cart-continue:hover {
    color: #ffffff;
  }

  /* ========== FREE SHIPPING BAR ========== */
  .velox-shipping-bar {
    margin-bottom: 2rem;
    padding: 1rem 1.25rem;
    background-color: #f9fafb;
    border-radius: 0.75rem;
  }

  .velox-cart--dark .velox-shipping-bar {
    background-color: #1f2937;
  }

  .velox-shipping-message {
    font-size: 0.875rem;
    color: #374151;
    margin-bottom: 0.75rem;
  }

  .velox-shipping-message--success {
    color: #059669;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .velox-cart--dark .velox-shipping-message {
    color: #d1d5db;
  }

  .velox-shipping-progress {
    height: 0.5rem;
    background-color: #e5e7eb;
    border-radius: 9999px;
    overflow: hidden;
  }

  .velox-cart--dark .velox-shipping-progress {
    background-color: #374151;
  }

  .velox-shipping-progress-fill {
    height: 100%;
    background-color: var(--color-accent, #6366f1);
    border-radius: 9999px;
    transition: width 0.5s ease;
  }

  /* ========== MAIN LAYOUT ========== */
  .velox-cart-layout {
    display: block;
  }

  @media (min-width: 1024px) {
    .velox-cart-layout {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 3rem;
      align-items: start;
    }
  }

  @media (min-width: 1280px) {
    .velox-cart-layout {
      grid-template-columns: 1fr 420px;
      gap: 4rem;
    }
  }

  .velox-cart-layout--single {
    max-width: 48rem;
    margin: 0 auto;
  }

  /* ========== CART ITEMS ========== */
  .velox-cart-items-list {
    list-style: none;
    margin: 0;
    padding: 0;
    border-top: 1px solid #e5e7eb;
    border-bottom: 1px solid #e5e7eb;
  }

  .velox-cart--dark .velox-cart-items-list {
    border-color: #374151;
  }

  .velox-cart-item {
    display: flex;
    padding: 1.5rem 0;
    border-bottom: 1px solid #e5e7eb;
    transition: opacity 0.3s ease, transform 0.3s ease;
  }

  .velox-cart-item:last-child {
    border-bottom: none;
  }

  .velox-cart--dark .velox-cart-item {
    border-color: #374151;
  }

  @media (min-width: 640px) {
    .velox-cart-item {
      padding: 2.5rem 0;
    }
  }

  .velox-cart-item.is-updating {
    opacity: 0.5;
    pointer-events: none;
  }

  .velox-cart-item.is-removing {
    opacity: 0;
    transform: translateX(-20px);
  }

  /* ========== PRODUCT IMAGE ========== */
  .velox-cart-item-image {
    flex-shrink: 0;
    width: 5rem;
    height: 6rem;
    background-color: #f3f4f6;
    border-radius: 0.5rem;
    overflow: hidden;
  }

  @media (min-width: 640px) {
    .velox-cart-item-image {
      width: 8rem;
      height: 10rem;
    }
  }

  @media (min-width: 1024px) {
    .velox-cart-item-image {
      width: 10rem;
      height: 12rem;
    }
  }

  .velox-cart-item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .velox-cart-item-image-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #9ca3af;
  }

  /* ========== PRODUCT INFO ========== */
  .velox-cart-item-content {
    flex: 1;
    margin-left: 1rem;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }

  @media (min-width: 640px) {
    .velox-cart-item-content {
      margin-left: 1.5rem;
    }
  }

  .velox-cart-item-header {
    position: relative;
    padding-right: 2.25rem;
  }

  @media (min-width: 640px) {
    .velox-cart-item-header {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 1.5rem;
      padding-right: 0;
    }
  }

  .velox-cart-item-title {
    font-size: 0.875rem;
    font-weight: 500;
    color: #374151;
    text-decoration: none;
    transition: color 0.15s;
    display: block;
    line-height: 1.4;
  }

  .velox-cart-item-title:hover {
    color: #111827;
  }

  .velox-cart--dark .velox-cart-item-title {
    color: #d1d5db;
  }

  .velox-cart--dark .velox-cart-item-title:hover {
    color: #ffffff;
  }

  .velox-cart-item-variant {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
    margin-top: 0.25rem;
    font-size: 0.875rem;
    color: #6b7280;
  }

  .velox-cart-item-variant span:not(:last-child)::after {
    content: "·";
    margin-left: 0.375rem;
    color: #d1d5db;
  }

  .velox-cart-item-price {
    margin-top: 0.25rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: #111827;
  }

  .velox-cart--dark .velox-cart-item-price {
    color: #ffffff;
  }

  .velox-cart-item-price--sale {
    color: var(--color-accent, #dc2626);
  }

  .velox-cart-item-price-original {
    margin-left: 0.5rem;
    color: #9ca3af;
    text-decoration: line-through;
  }

  /* ========== QUANTITY CONTROLS ========== */
  .velox-cart-item-controls {
    margin-top: 1rem;
  }

  @media (min-width: 640px) {
    .velox-cart-item-controls {
      margin-top: 0;
    }
  }

  .velox-quantity-selector {
    display: grid;
    grid-template-columns: 1fr;
    width: 100%;
    max-width: 5rem;
  }

  .velox-quantity-select {
    grid-column: 1;
    grid-row: 1;
    appearance: none;
    background-color: #ffffff;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    padding: 0.375rem 2rem 0.375rem 0.75rem;
    font-size: 0.875rem;
    color: #111827;
    cursor: pointer;
    transition: border-color 0.15s, box-shadow 0.15s;
  }

  .velox-cart--dark .velox-quantity-select {
    background-color: #1f2937;
    border-color: #4b5563;
    color: #ffffff;
  }

  .velox-quantity-select:focus {
    outline: none;
    border-color: var(--color-accent, #6366f1);
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
  }

  .velox-quantity-icon {
    grid-column: 1;
    grid-row: 1;
    pointer-events: none;
    margin-right: 0.5rem;
    width: 1rem;
    height: 1rem;
    align-self: center;
    justify-self: end;
    color: #6b7280;
  }

  /* ========== REMOVE BUTTON ========== */
  .velox-cart-item-remove {
    position: absolute;
    top: 0;
    right: 0;
    padding: 0.5rem;
    margin: -0.5rem;
    background: none;
    border: none;
    color: #9ca3af;
    cursor: pointer;
    transition: color 0.15s;
  }

  .velox-cart-item-remove:hover {
    color: #6b7280;
  }

  .velox-cart-item-remove svg {
    width: 1.25rem;
    height: 1.25rem;
  }

  /* ========== STOCK STATUS ========== */
  .velox-cart-item-stock {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1rem;
    font-size: 0.875rem;
    color: #374151;
  }

  .velox-cart-item-stock svg {
    width: 1.25rem;
    height: 1.25rem;
    flex-shrink: 0;
  }

  .velox-cart-item-stock--available svg {
    color: #10b981;
  }

  /* ========== DISCOUNTS ========== */
  .velox-cart-item-discounts {
    margin-top: 0.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .velox-cart-item-discount {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.75rem;
    color: var(--color-accent, #6366f1);
  }

  .velox-cart-item-discount svg {
    width: 0.75rem;
    height: 0.75rem;
  }

  /* ========== CART NOTE ========== */
  .velox-cart-note {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e5e7eb;
  }

  .velox-cart--dark .velox-cart-note {
    border-color: #374151;
  }

  .velox-cart-note-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: #374151;
    margin-bottom: 0.5rem;
  }

  .velox-cart--dark .velox-cart-note-label {
    color: #d1d5db;
  }

  .velox-cart-note-textarea {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    color: #111827;
    background-color: #ffffff;
    resize: none;
    transition: border-color 0.15s, box-shadow 0.15s;
  }

  .velox-cart--dark .velox-cart-note-textarea {
    background-color: #1f2937;
    border-color: #4b5563;
    color: #ffffff;
  }

  .velox-cart-note-textarea:focus {
    outline: none;
    border-color: var(--color-accent, #6366f1);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }

  .velox-cart-note-textarea::placeholder {
    color: #9ca3af;
  }

  /* ========== ORDER SUMMARY ========== */
  .velox-order-summary {
    margin-top: 2rem;
  }

  @media (min-width: 1024px) {
    .velox-order-summary {
      margin-top: 0;
      position: sticky;
      top: 2rem;
    }
  }

  .velox-order-summary-card {
    background-color: #f9fafb;
    border-radius: 0.75rem;
    padding: 1.5rem;
  }

  @media (min-width: 640px) {
    .velox-order-summary-card {
      padding: 2rem;
    }
  }

  .velox-cart--dark .velox-order-summary-card {
    background-color: #1f2937;
  }

  .velox-order-summary-title {
    font-size: 1.125rem;
    font-weight: 500;
    color: #111827;
    margin-bottom: 1.5rem;
  }

  .velox-cart--dark .velox-order-summary-title {
    color: #ffffff;
  }

  .velox-order-summary-rows {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .velox-order-summary-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .velox-order-summary-row--border {
    padding-top: 1rem;
    border-top: 1px solid #e5e7eb;
  }

  .velox-cart--dark .velox-order-summary-row--border {
    border-color: #374151;
  }

  .velox-order-summary-label {
    font-size: 0.875rem;
    color: #6b7280;
  }

  .velox-order-summary-value {
    font-size: 0.875rem;
    font-weight: 500;
    color: #111827;
  }

  .velox-cart--dark .velox-order-summary-value {
    color: #ffffff;
  }

  .velox-order-summary-row--total .velox-order-summary-label,
  .velox-order-summary-row--total .velox-order-summary-value {
    font-size: 1rem;
    font-weight: 600;
    color: #111827;
  }

  .velox-cart--dark .velox-order-summary-row--total .velox-order-summary-label,
  .velox-cart--dark .velox-order-summary-row--total .velox-order-summary-value {
    color: #ffffff;
  }

  .velox-order-summary-discount {
    color: var(--color-accent, #6366f1);
  }

  .velox-order-summary-discount .velox-order-summary-label {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    color: var(--color-accent, #6366f1);
  }

  .velox-order-summary-discount svg {
    width: 1rem;
    height: 1rem;
  }

  .velox-order-summary-savings {
    color: #059669;
  }

  .velox-order-summary-notice {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #e5e7eb;
    font-size: 0.875rem;
    color: #6b7280;
  }

  .velox-cart--dark .velox-order-summary-notice {
    border-color: #374151;
  }

  /* ========== CHECKOUT BUTTON ========== */
  .velox-checkout-actions {
    margin-top: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .velox-checkout-button {
    display: block;
    width: 100%;
    padding: 1rem 1.5rem;
    background-color: var(--color-accent, #6366f1);
    color: #ffffff;
    font-size: 1rem;
    font-weight: 600;
    text-align: center;
    text-decoration: none;
    border: none;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: background-color 0.15s, transform 0.1s;
  }

  .velox-checkout-button:hover {
    background-color: var(--color-accent-dark, #4f46e5);
  }

  .velox-checkout-button:active {
    transform: scale(0.98);
  }

  /* ========== PAYMENT ICONS ========== */
  .velox-payment-icons {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e5e7eb;
    text-align: center;
  }

  .velox-cart--dark .velox-payment-icons {
    border-color: #374151;
  }

  .velox-payment-icons-label {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.375rem;
    font-size: 0.75rem;
    color: #6b7280;
    margin-bottom: 0.75rem;
  }

  .velox-payment-icons-label svg {
    width: 1rem;
    height: 1rem;
  }

  .velox-payment-icons-list {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .velox-payment-icons-list li svg {
    height: 1.5rem;
    width: auto;
  }

  /* ========== EMPTY CART ========== */
  .velox-cart-empty {
    text-align: center;
    padding: 4rem 1rem;
    max-width: 24rem;
    margin: 0 auto;
  }

  .velox-cart-empty-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 5rem;
    height: 5rem;
    background-color: #f3f4f6;
    border-radius: 50%;
    margin-bottom: 1.5rem;
  }

  .velox-cart--dark .velox-cart-empty-icon {
    background-color: #1f2937;
  }

  .velox-cart-empty-icon svg {
    width: 2.5rem;
    height: 2.5rem;
    color: #9ca3af;
  }

  .velox-cart-empty-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #111827;
    margin-bottom: 0.5rem;
  }

  .velox-cart--dark .velox-cart-empty-title {
    color: #ffffff;
  }

  .velox-cart-empty-message {
    font-size: 0.875rem;
    color: #6b7280;
    margin-bottom: 2rem;
  }

  .velox-cart-empty-button {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.875rem 2rem;
    background-color: var(--color-accent, #6366f1);
    color: #ffffff;
    font-size: 0.875rem;
    font-weight: 600;
    text-decoration: none;
    border-radius: 0.5rem;
    transition: background-color 0.15s;
  }

  .velox-cart-empty-button:hover {
    background-color: var(--color-accent-dark, #4f46e5);
  }

  .velox-cart-empty-button svg {
    width: 1.25rem;
    height: 1.25rem;
  }
{% endstyle %}

<div
  class="velox-cart velox-cart--{{ color_scheme }}"
  data-section-id="{{ section.id }}"
  data-section-type="cart"
>
  <div class="velox-cart-container">
    {%- comment -%} Header {%- endcomment -%}
    <div class="velox-cart-header">
      <h1 class="velox-cart-title">
        {{ 'cart.general.title' | t }}
      </h1>
      {% if show_continue_shopping %}
        <a href="{{ routes.all_products_collection_url }}" class="velox-cart-continue">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 1rem; height: 1rem;">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
          </svg>
          {{ 'cart.general.continue_shopping' | t }}
        </a>
      {% endif %}
    </div>

    {% if cart.item_count > 0 %}
      {%- comment -%} Free shipping bar {%- endcomment -%}
      {% if show_free_shipping and free_shipping_threshold > 0 %}
        <div class="velox-shipping-bar" data-free-shipping-bar>
          {% if amount_remaining > 0 %}
            <p class="velox-shipping-message" data-shipping-message>
              {{ 'cart.general.free_shipping_remaining_html' | t: remaining: amount_remaining | money }}
            </p>
          {% else %}
            <p class="velox-shipping-message velox-shipping-message--success" data-shipping-message>
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 1.25rem; height: 1.25rem;">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
              </svg>
              {{ 'cart.general.free_shipping_achieved' | t }}
            </p>
          {% endif %}
          <div class="velox-shipping-progress">
            <div
              class="velox-shipping-progress-fill"
              style="width: {{ progress_percentage }}%;"
              data-shipping-progress
            ></div>
          </div>
        </div>
      {% endif %}

      {%- comment -%} Main layout {%- endcomment -%}
      <div class="velox-cart-layout{% if layout_style == 'single_column' %} velox-cart-layout--single{% endif %}">
        {%- comment -%} Cart items {%- endcomment -%}
        <section aria-labelledby="cart-heading">
          <h2 id="cart-heading" class="sr-only">{{ 'cart.general.title' | t }}</h2>

          <form action="{{ routes.cart_url }}" method="post" id="cart-form">
            <ul class="velox-cart-items-list" data-cart-items>
              {% for item in cart.items %}
                <li
                  class="velox-cart-item"
                  data-cart-item="{{ item.key }}"
                  data-item-index="{{ forloop.index }}"
                >
                  {%- comment -%} Product image {%- endcomment -%}
                  <a href="{{ item.url }}" class="velox-cart-item-image">
                    {% if item.image %}
                      {{ item.image | image_url: width: 400 | image_tag:
                        alt: item.title,
                        loading: 'lazy'
                      }}
                    {% else %}
                      <div class="velox-cart-item-image-placeholder">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 2.5rem; height: 2.5rem;">
                          <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
                        </svg>
                      </div>
                    {% endif %}
                  </a>

                  {%- comment -%} Product content {%- endcomment -%}
                  <div class="velox-cart-item-content">
                    <div class="velox-cart-item-header">
                      <div>
                        <a href="{{ item.url }}" class="velox-cart-item-title">
                          {{ item.product.title }}
                        </a>

                        {% if item.variant.title != 'Default Title' %}
                          <div class="velox-cart-item-variant">
                            {% for option in item.variant.options %}
                              <span>{{ option }}</span>
                            {% endfor %}
                          </div>
                        {% endif %}

                        <p class="velox-cart-item-price{% if item.original_price != item.final_price %} velox-cart-item-price--sale{% endif %}">
                          {{ item.final_price | money }}
                          {% if item.original_price != item.final_price %}
                            <span class="velox-cart-item-price-original">{{ item.original_price | money }}</span>
                          {% endif %}
                        </p>

                        {%- comment -%} Line discounts {%- endcomment -%}
                        {% if item.line_level_discount_allocations.size > 0 %}
                          <div class="velox-cart-item-discounts">
                            {% for discount in item.line_level_discount_allocations %}
                              <span class="velox-cart-item-discount">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 0 0 3 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 0 0 5.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 0 0 9.568 3Z" />
                                </svg>
                                {{ discount.discount_application.title }} (-{{ discount.amount | money }})
                              </span>
                            {% endfor %}
                          </div>
                        {% endif %}
                      </div>

                      {%- comment -%} Quantity selector {%- endcomment -%}
                      <div class="velox-cart-item-controls">
                        <div class="velox-quantity-selector">
                          <select
                            name="updates[]"
                            aria-label="{{ 'cart.general.quantity' | t }}, {{ item.product.title }}"
                            class="velox-quantity-select"
                            data-quantity-select="{{ item.key }}"
                            data-line="{{ forloop.index }}"
                          >
                            {% for i in (1..10) %}
                              <option value="{{ i }}" {% if item.quantity == i %}selected{% endif %}>{{ i }}</option>
                            {% endfor %}
                          </select>
                          <svg viewBox="0 0 16 16" fill="currentColor" aria-hidden="true" class="velox-quantity-icon">
                            <path d="M4.22 6.22a.75.75 0 0 1 1.06 0L8 8.94l2.72-2.72a.75.75 0 1 1 1.06 1.06l-3.25 3.25a.75.75 0 0 1-1.06 0L4.22 7.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" fill-rule="evenodd" />
                          </svg>
                        </div>
                      </div>

                      {%- comment -%} Remove button {%- endcomment -%}
                      <button
                        type="button"
                        class="velox-cart-item-remove"
                        data-remove-item="{{ item.key }}"
                        aria-label="{{ 'cart.general.remove_item' | t: title: item.title }}"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                        </svg>
                      </button>
                    </div>

                    {%- comment -%} Stock status {%- endcomment -%}
                    {% if item.variant.available %}
                      <p class="velox-cart-item-stock velox-cart-item-stock--available">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 0 1 .143 1.052l-8 10.5a.75.75 0 0 1-1.127.075l-4.5-4.5a.75.75 0 0 1 1.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 0 1 1.05-.143Z" clip-rule="evenodd" />
                        </svg>
                        <span>{{ 'products.product.in_stock' | t | default: 'En stock' }}</span>
                      </p>
                    {% endif %}
                  </div>
                </li>
              {% endfor %}
            </ul>

            {%- comment -%} Cart note {%- endcomment -%}
            {% if show_cart_note %}
              <div class="velox-cart-note">
                <label for="cart-note" class="velox-cart-note-label">
                  {{ 'cart.general.note' | t }}
                </label>
                <textarea
                  id="cart-note"
                  name="note"
                  rows="3"
                  class="velox-cart-note-textarea"
                  placeholder="{{ 'cart.general.note_placeholder' | t }}"
                  data-cart-note
                >{{ cart.note }}</textarea>
              </div>
            {% endif %}

            <noscript>
              <button type="submit" style="margin-top: 1rem; padding: 0.75rem 1.5rem; background: var(--color-accent); color: white; border: none; border-radius: 0.375rem; cursor: pointer;">
                {{ 'cart.update' | t }}
              </button>
            </noscript>
          </form>
        </section>

        {%- comment -%} Order summary {%- endcomment -%}
        <section aria-labelledby="summary-heading" class="velox-order-summary">
          <div class="velox-order-summary-card">
            <h2 id="summary-heading" class="velox-order-summary-title">
              {{ 'cart.general.order_summary' | t }}
            </h2>

            <dl class="velox-order-summary-rows">
              {%- comment -%} Subtotal {%- endcomment -%}
              <div class="velox-order-summary-row">
                <dt class="velox-order-summary-label">{{ 'cart.general.subtotal' | t }}</dt>
                <dd class="velox-order-summary-value" data-cart-subtotal>{{ cart.original_total_price | money }}</dd>
              </div>

              {%- comment -%} Cart discounts {%- endcomment -%}
              {% if cart.cart_level_discount_applications.size > 0 %}
                {% for discount in cart.cart_level_discount_applications %}
                  <div class="velox-order-summary-row velox-order-summary-discount">
                    <dt class="velox-order-summary-label">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 0 0 3 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 0 0 5.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 0 0 9.568 3Z" />
                      </svg>
                      {{ discount.title }}
                    </dt>
                    <dd class="velox-order-summary-value">-{{ discount.total_allocated_amount | money }}</dd>
                  </div>
                {% endfor %}
              {% endif %}

              {%- comment -%} Savings {%- endcomment -%}
              {% if cart.total_discount > 0 %}
                <div class="velox-order-summary-row velox-order-summary-row--border velox-order-summary-savings">
                  <dt class="velox-order-summary-label">{{ 'cart.general.savings' | t }}</dt>
                  <dd class="velox-order-summary-value" data-cart-savings>{{ cart.total_discount | money }}</dd>
                </div>
              {% endif %}

              {%- comment -%} Shipping notice {%- endcomment -%}
              <p class="velox-order-summary-notice">
                {{ 'cart.general.shipping_at_checkout' | t }}
              </p>

              {%- comment -%} Total {%- endcomment -%}
              <div class="velox-order-summary-row velox-order-summary-row--border velox-order-summary-row--total">
                <dt class="velox-order-summary-label">Total</dt>
                <dd class="velox-order-summary-value" data-cart-total>{{ cart.total_price | money }}</dd>
              </div>
            </dl>

            {%- comment -%} Checkout {%- endcomment -%}
            <div class="velox-checkout-actions">
              <a href="{{ routes.cart_url }}/checkout" class="velox-checkout-button">
                {{ 'cart.general.checkout' | t }}
              </a>

              {% if additional_checkout_buttons %}
                {{ content_for_additional_checkout_buttons }}
              {% endif %}
            </div>

            {%- comment -%} Payment icons {%- endcomment -%}
            {% if section.settings.show_payment_icons %}
              <div class="velox-payment-icons">
                <p class="velox-payment-icons-label">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z" />
                  </svg>
                  {{ 'cart.general.secure_checkout' | t }}
                </p>
                <ul class="velox-payment-icons-list">
                  {% for type in shop.enabled_payment_types %}
                    <li>{{ type | payment_type_svg_tag }}</li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
          </div>
        </section>
      </div>

    {% else %}
      {%- comment -%} Empty cart {%- endcomment -%}
      <div class="velox-cart-empty" data-cart-empty>
        <div class="velox-cart-empty-icon">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5V6a3.75 3.75 0 1 0-7.5 0v4.5m11.356-1.993 1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 0 1-1.12-1.243l1.264-12A1.125 1.125 0 0 1 5.513 7.5h12.974c.576 0 1.059.435 1.119 1.007ZM8.625 10.5a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm7.5 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
          </svg>
        </div>
        <h2 class="velox-cart-empty-title">
          {{ 'cart.general.empty' | t }}
        </h2>
        <p class="velox-cart-empty-message">
          {{ 'cart.general.empty_message' | t }}
        </p>
        <a href="{{ routes.all_products_collection_url }}" class="velox-cart-empty-button">
          {{ 'cart.general.start_shopping' | t }}
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5 21 12m0 0-7.5 7.5M21 12H3" />
          </svg>
        </a>
      </div>
    {% endif %}
  </div>
</div>

<script>
  (function() {
    const section = document.querySelector('[data-section-id="{{ section.id }}"]');
    if (!section) return;

    const freeShippingThreshold = {{ free_shipping_threshold | default: 0 }};

    // Debounce helper
    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    // Format money
    function formatMoney(cents) {
      const format = '{{ shop.money_format }}';
      const amount = (cents / 100).toFixed(2);
      return format
        .replace(/\{\{\s*amount\s*\}\}/, amount)
        .replace(/\{\{\s*amount_no_decimals\s*\}\}/, Math.round(cents / 100))
        .replace(/\{\{\s*amount_with_comma_separator\s*\}\}/, amount.replace('.', ','));
    }

    // Update item quantity
    async function updateItemQuantity(key, quantity) {
      const item = section.querySelector(`[data-cart-item="${key}"]`);
      if (item) item.classList.add('is-updating');

      try {
        const response = await fetch('/cart/change.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: key, quantity: parseInt(quantity) })
        });

        if (!response.ok) throw new Error('Update failed');

        const cart = await response.json();

        if (cart.item_count === 0) {
          window.location.reload();
          return;
        }

        if (item) item.classList.remove('is-updating');
        updateCartUI(cart);
        return cart;
      } catch (error) {
        console.error('Error updating quantity:', error);
        if (item) item.classList.remove('is-updating');
        window.location.reload();
      }
    }

    // Remove item
    async function removeItem(key) {
      const item = section.querySelector(`[data-cart-item="${key}"]`);
      if (item) item.classList.add('is-removing');

      try {
        const response = await fetch('/cart/change.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: key, quantity: 0 })
        });

        if (!response.ok) throw new Error('Remove failed');

        const cart = await response.json();

        if (cart.item_count === 0) {
          window.location.reload();
          return;
        }

        setTimeout(() => {
          if (item) item.remove();
          updateCartUI(cart);
        }, 300);

        return cart;
      } catch (error) {
        console.error('Error removing item:', error);
        window.location.reload();
      }
    }

    // Update cart UI
    function updateCartUI(cart) {
      const subtotal = section.querySelector('[data-cart-subtotal]');
      const total = section.querySelector('[data-cart-total]');
      const savings = section.querySelector('[data-cart-savings]');

      if (subtotal) subtotal.textContent = formatMoney(cart.original_total_price);
      if (total) total.textContent = formatMoney(cart.total_price);
      if (savings && cart.total_discount > 0) {
        savings.textContent = formatMoney(cart.total_discount);
      }

      // Update quantities
      cart.items.forEach(item => {
        const select = section.querySelector(`[data-quantity-select="${item.key}"]`);
        if (select && parseInt(select.value) !== item.quantity) {
          select.value = item.quantity;
        }
      });

      // Update free shipping
      updateFreeShippingBar(cart);

      // Update header cart count
      document.querySelectorAll('[data-cart-count]').forEach(el => {
        el.textContent = cart.item_count;
      });

      document.dispatchEvent(new CustomEvent('cart:updated', { detail: cart }));
    }

    // Update free shipping bar
    function updateFreeShippingBar(cart) {
      if (freeShippingThreshold <= 0) return;

      const progress = section.querySelector('[data-shipping-progress]');
      const message = section.querySelector('[data-shipping-message]');

      if (!progress) return;

      const remaining = freeShippingThreshold - cart.total_price;
      const percentage = Math.min((cart.total_price / freeShippingThreshold) * 100, 100);

      progress.style.width = percentage + '%';

      if (message) {
        if (remaining > 0) {
          message.className = 'velox-shipping-message';
          message.innerHTML = `{{ 'cart.general.free_shipping_remaining_html' | t }}`.replace('{{ remaining }}', formatMoney(remaining)).replace(/\{\{\s*remaining\s*\}\}/g, formatMoney(remaining));
        } else {
          message.className = 'velox-shipping-message velox-shipping-message--success';
          message.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 1.25rem; height: 1.25rem;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg> {{ 'cart.general.free_shipping_achieved' | t }}`;
        }
      }
    }

    // Quantity select change
    section.querySelectorAll('[data-quantity-select]').forEach(select => {
      select.addEventListener('change', function() {
        const key = this.dataset.quantitySelect;
        updateItemQuantity(key, this.value);
      });
    });

    // Remove buttons
    section.querySelectorAll('[data-remove-item]').forEach(btn => {
      btn.addEventListener('click', function() {
        removeItem(this.dataset.removeItem);
      });
    });

    // Cart note auto-save
    const cartNote = section.querySelector('[data-cart-note]');
    if (cartNote) {
      const saveNote = debounce(note => {
        fetch('/cart/update.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ note })
        });
      }, 800);

      cartNote.addEventListener('input', function() {
        saveNote(this.value);
      });
    }
  })();
</script>

{% schema %}
{
  "name": "t:sections.cart.name",
  "tag": "section",
  "class": "section-cart",
  "enabled_on": {
    "templates": ["cart"]
  },
  "settings": [
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "select",
      "id": "layout_style",
      "label": "Estilo de layout",
      "options": [
        { "value": "two_column", "label": "Dos columnas" },
        { "value": "single_column", "label": "Una columna" }
      ],
      "default": "two_column"
    },
    {
      "type": "header",
      "content": "Envío gratis"
    },
    {
      "type": "checkbox",
      "id": "show_free_shipping",
      "label": "Mostrar barra de envío gratis",
      "default": true
    },
    {
      "type": "number",
      "id": "free_shipping_threshold",
      "label": "Umbral de envío gratis",
      "info": "Monto mínimo para envío gratis (en la moneda de la tienda)",
      "default": 100
    },
    {
      "type": "header",
      "content": "Opciones"
    },
    {
      "type": "checkbox",
      "id": "show_cart_note",
      "label": "Mostrar campo de nota",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_continue_shopping",
      "label": "Mostrar enlace de seguir comprando",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_payment_icons",
      "label": "Mostrar iconos de pago",
      "default": true
    },
    {
      "type": "header",
      "content": "Esquema de colores"
    },
    {
      "type": "select",
      "id": "color_scheme",
      "label": "Esquema de colores",
      "options": [
        { "value": "light", "label": "Claro" },
        { "value": "dark", "label": "Oscuro" }
      ],
      "default": "light"
    }
  ]
}
{% endschema %}
