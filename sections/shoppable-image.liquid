{% comment %}
  Velox Shoppable Image
  Imagen con hotspots interactivos que muestran productos.
  Ideal para lookbooks, lifestyle imagery, y decoraci√≥n.
{% endcomment %}

<section
  class="shoppable-image-section tw-py-12 lg:tw-py-20"
  data-section-id="{{ section.id }}"
  data-animate="fade-up"
>
  <div class="tw-max-w-7xl tw-mx-auto tw-px-4">
    {%- comment -%} Header {%- endcomment -%}
    {% if section.settings.heading != blank or section.settings.subheading != blank %}
      <div class="tw-text-center tw-mb-10">
        {% if section.settings.subheading != blank %}
          <p class="tw-text-sm tw-font-medium tw-text-accent tw-uppercase tw-tracking-wider tw-mb-2">
            {{ section.settings.subheading }}
          </p>
        {% endif %}
        {% if section.settings.heading != blank %}
          <h2 class="tw-text-3xl lg:tw-text-4xl tw-font-bold tw-text-velox-900">
            {{ section.settings.heading }}
          </h2>
        {% endif %}
      </div>
    {% endif %}

    {%- comment -%} Shoppable Image Container {%- endcomment -%}
    <shoppable-image
      class="tw-block tw-relative tw-rounded-xl tw-overflow-hidden tw-shadow-lg"
      style="max-width: {{ section.settings.max_width }}px; margin: 0 auto;"
    >
      {%- comment -%} Base Image {%- endcomment -%}
      <div class="shoppable-image__container tw-relative">
        {% if section.settings.image != blank %}
          {{ section.settings.image | image_url: width: 1600 | image_tag:
            class: 'tw-w-full tw-h-auto tw-block',
            loading: 'lazy',
            alt: section.settings.image.alt | default: section.settings.heading
          }}
        {% else %}
          {{ 'lifestyle-2' | placeholder_svg_tag: 'tw-w-full tw-h-auto tw-block tw-bg-velox-100' }}
        {% endif %}

        {%- comment -%} Hotspots {%- endcomment -%}
        {% for block in section.blocks %}
          {% if block.type == 'hotspot' %}
            {% assign product = block.settings.product %}
            <div
              class="shoppable-hotspot tw-absolute tw-z-10"
              style="left: {{ block.settings.position_x }}%; top: {{ block.settings.position_y }}%;"
              data-hotspot-id="{{ block.id }}"
              {{ block.shopify_attributes }}
            >
              {%- comment -%} Hotspot Button {%- endcomment -%}
              <button
                type="button"
                class="shoppable-hotspot__button tw-relative tw-w-8 tw-h-8 tw-rounded-full tw-border-2 tw-border-white tw-shadow-lg tw-cursor-pointer tw-transition-transform tw-duration-200 hover:tw-scale-110 focus:tw-outline-none focus:tw-ring-2 focus:tw-ring-offset-2 focus:tw-ring-velox-accent
                  {% case section.settings.hotspot_style %}
                    {% when 'primary' %}
                      tw-bg-velox-900
                    {% when 'accent' %}
                      tw-bg-velox-accent
                    {% when 'white' %}
                      tw-bg-white tw-border-velox-900
                  {% endcase %}
                "
                aria-label="{{ 'sections.shoppable.view_product' | t }}"
                aria-expanded="false"
                data-hotspot-trigger
              >
                {%- comment -%} Pulse Animation {%- endcomment -%}
                <span class="tw-absolute tw-inset-0 tw-rounded-full tw-animate-ping tw-opacity-50
                  {% case section.settings.hotspot_style %}
                    {% when 'primary' %}
                      tw-bg-velox-900
                    {% when 'accent' %}
                      tw-bg-velox-accent
                    {% when 'white' %}
                      tw-bg-white
                  {% endcase %}
                "></span>
                {%- comment -%} Plus Icon {%- endcomment -%}
                <svg class="tw-w-4 tw-h-4 tw-absolute tw-inset-0 tw-m-auto
                  {% if section.settings.hotspot_style == 'white' %}
                    tw-text-velox-900
                  {% else %}
                    tw-text-white
                  {% endif %}
                " fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
              </button>

              {%- comment -%} Product Popup {%- endcomment -%}
              <div
                class="shoppable-hotspot__popup tw-absolute tw-z-20 tw-w-64 tw-bg-white tw-rounded-lg tw-shadow-xl tw-p-4 tw-opacity-0 tw-invisible tw-transition-all tw-duration-200 tw-pointer-events-none
                  {% if block.settings.position_x > 50 %}
                    tw-right-full tw-mr-4
                  {% else %}
                    tw-left-full tw-ml-4
                  {% endif %}
                  {% if block.settings.position_y > 50 %}
                    tw-bottom-0
                  {% else %}
                    tw-top-0
                  {% endif %}
                "
                data-hotspot-popup
              >
                {% if product != blank %}
                  {%- comment -%} Product Image {%- endcomment -%}
                  {% if product.featured_image != blank %}
                    <a href="{{ product.url }}" class="tw-block tw-mb-3">
                      {{ product.featured_image | image_url: width: 400 | image_tag:
                        class: 'tw-w-full tw-h-32 tw-object-cover tw-rounded-md',
                        loading: 'lazy',
                        alt: product.title
                      }}
                    </a>
                  {% endif %}

                  {%- comment -%} Product Info {%- endcomment -%}
                  <a href="{{ product.url }}" class="tw-block tw-group">
                    <h4 class="tw-text-sm tw-font-semibold tw-text-velox-900 tw-mb-1 group-hover:tw-text-velox-accent tw-transition-colors">
                      {{ product.title }}
                    </h4>
                  </a>

                  {%- comment -%} Price {%- endcomment -%}
                  <div class="tw-flex tw-items-center tw-gap-2 tw-mb-3">
                    {% if product.compare_at_price > product.price %}
                      <span class="tw-text-sm tw-text-velox-500 tw-line-through">
                        {{ product.compare_at_price | money }}
                      </span>
                    {% endif %}
                    <span class="tw-text-sm tw-font-bold tw-text-velox-900">
                      {{ product.price | money }}
                    </span>
                  </div>

                  {%- comment -%} View Button {%- endcomment -%}
                  <a
                    href="{{ product.url }}"
                    class="tw-block tw-w-full tw-text-center tw-py-2 tw-px-4 tw-text-sm tw-font-medium tw-rounded-md tw-transition-colors tw-bg-velox-900 tw-text-white hover:tw-bg-velox-800"
                  >
                    {{ 'sections.shoppable.view_product' | t }}
                  </a>
                {% else %}
                  {%- comment -%} No Product Selected {%- endcomment -%}
                  <div class="tw-text-center tw-py-4">
                    <p class="tw-text-sm tw-text-velox-500">
                      {{ 'sections.shoppable.select_product' | t }}
                    </p>
                  </div>
                {% endif %}

                {%- comment -%} Custom Content {%- endcomment -%}
                {% if block.settings.custom_text != blank %}
                  <p class="tw-text-xs tw-text-velox-600 tw-mt-2 tw-pt-2 tw-border-t tw-border-velox-100">
                    {{ block.settings.custom_text }}
                  </p>
                {% endif %}
              </div>
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </shoppable-image>

    {%- comment -%} Caption {%- endcomment -%}
    {% if section.settings.caption != blank %}
      <p class="tw-text-center tw-text-velox-600 tw-mt-6 tw-text-sm">
        {{ section.settings.caption }}
      </p>
    {% endif %}
  </div>
</section>

<style>
  .shoppable-hotspot__popup.is-active {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
  }

  /* Mobile: popup aparece abajo del hotspot */
  @media (max-width: 640px) {
    .shoppable-hotspot__popup {
      left: 50% !important;
      right: auto !important;
      transform: translateX(-50%);
      margin-left: 0 !important;
      margin-right: 0 !important;
      top: 100% !important;
      bottom: auto !important;
      margin-top: 0.5rem;
    }
  }
</style>

<script>
(function() {
  class ShoppableImage extends HTMLElement {
    constructor() {
      super();
      this.hotspots = this.querySelectorAll('[data-hotspot-trigger]');
      this.activePopup = null;
    }

    connectedCallback() {
      this.setupHotspots();
      this.setupOutsideClick();
    }

    setupHotspots() {
      this.hotspots.forEach(trigger => {
        const hotspot = trigger.closest('.shoppable-hotspot');
        const popup = hotspot.querySelector('[data-hotspot-popup]');

        if (!popup) return;

        trigger.addEventListener('click', (e) => {
          e.stopPropagation();
          this.togglePopup(popup, trigger);
        });

        // Keyboard accessibility
        trigger.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            this.togglePopup(popup, trigger);
          } else if (e.key === 'Escape') {
            this.closeAllPopups();
          }
        });
      });
    }

    togglePopup(popup, trigger) {
      const isActive = popup.classList.contains('is-active');

      // Cerrar todos primero
      this.closeAllPopups();

      if (!isActive) {
        popup.classList.add('is-active');
        trigger.setAttribute('aria-expanded', 'true');
        this.activePopup = popup;
      }
    }

    closeAllPopups() {
      this.querySelectorAll('[data-hotspot-popup]').forEach(popup => {
        popup.classList.remove('is-active');
      });
      this.hotspots.forEach(trigger => {
        trigger.setAttribute('aria-expanded', 'false');
      });
      this.activePopup = null;
    }

    setupOutsideClick() {
      document.addEventListener('click', (e) => {
        if (this.activePopup && !this.contains(e.target)) {
          this.closeAllPopups();
        }
      });
    }
  }

  if (!customElements.get('shoppable-image')) {
    customElements.define('shoppable-image', ShoppableImage);
  }
})();
</script>

{% schema %}
{
  "name": "Shoppable Image",
  "tag": "section",
  "class": "shoppable-image-section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Shop the Look"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading"
    },
    {
      "type": "image_picker",
      "id": "image",
      "label": "Image"
    },
    {
      "type": "range",
      "id": "max_width",
      "min": 800,
      "max": 1400,
      "step": 50,
      "default": 1200,
      "unit": "px",
      "label": "Maximum width"
    },
    {
      "type": "header",
      "content": "Hotspots"
    },
    {
      "type": "select",
      "id": "hotspot_style",
      "label": "Hotspot style",
      "options": [
        { "value": "primary", "label": "Primary (dark)" },
        { "value": "accent", "label": "Accent" },
        { "value": "white", "label": "White" }
      ],
      "default": "accent"
    },
    {
      "type": "textarea",
      "id": "caption",
      "label": "Caption (optional)"
    }
  ],
  "blocks": [
    {
      "type": "hotspot",
      "name": "Hotspot",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        },
        {
          "type": "range",
          "id": "position_x",
          "min": 5,
          "max": 95,
          "step": 1,
          "default": 50,
          "unit": "%",
          "label": "Horizontal position"
        },
        {
          "type": "range",
          "id": "position_y",
          "min": 5,
          "max": 95,
          "step": 1,
          "default": 50,
          "unit": "%",
          "label": "Vertical position"
        },
        {
          "type": "text",
          "id": "custom_text",
          "label": "Custom text (optional)",
          "info": "Additional note below the product info"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Shoppable Image",
      "settings": {
        "heading": "Shop the Look"
      },
      "blocks": [
        {
          "type": "hotspot",
          "settings": {
            "position_x": 30,
            "position_y": 40
          }
        },
        {
          "type": "hotspot",
          "settings": {
            "position_x": 70,
            "position_y": 60
          }
        }
      ]
    }
  ]
}
{% endschema %}
