{% comment %}
  Comparison Slider - Before/After Image Comparison
  Inspired by Shrine Pro

  Permite comparar dos imágenes con un slider interactivo.
  Ideal para: antes/después, con/sin producto, diferentes versiones.
{% endcomment %}

{{ 'comparison-slider.css' | asset_url | stylesheet_tag }}

<section 
  class="comparison-slider-section tw-py-12 lg:tw-py-20"
  data-section-id="{{ section.id }}"
  data-animate="fade-up"
>
  <div class="tw-max-w-7xl tw-mx-auto tw-px-4">
    {%- comment -%} Header {%- endcomment -%}
    {% if section.settings.heading != blank or section.settings.subheading != blank %}
      <div class="tw-text-center tw-mb-10">
        {% if section.settings.subheading != blank %}
          <p class="tw-text-sm tw-font-medium tw-text-accent tw-uppercase tw-tracking-wider tw-mb-2">
            {{ section.settings.subheading }}
          </p>
        {% endif %}
        {% if section.settings.heading != blank %}
          <h2 class="tw-text-3xl lg:tw-text-4xl tw-font-bold tw-text-velox-900">
            {{ section.settings.heading }}
          </h2>
        {% endif %}
      </div>
    {% endif %}

    {%- comment -%} Comparison Container {%- endcomment -%}
    <div 
      class="comparison-slider tw-relative tw-overflow-hidden tw-rounded-xl tw-shadow-lg"
      data-comparison-slider
      style="max-width: {{ section.settings.max_width }}px; margin: 0 auto;"
    >
      {%- comment -%} After Image (background) {%- endcomment -%}
      <div class="comparison-slider__after">
        {% if section.settings.after_image != blank %}
          {{ section.settings.after_image | image_url: width: 1600 | image_tag:
            class: 'tw-w-full tw-h-auto tw-block',
            loading: 'lazy',
            alt: section.settings.after_label | default: 'After'
          }}
        {% else %}
          {{ 'lifestyle-2' | placeholder_svg_tag: 'tw-w-full tw-h-auto tw-block tw-bg-velox-100' }}
        {% endif %}
        {% if section.settings.after_label != blank %}
          <span class="comparison-slider__label comparison-slider__label--after">
            {{ section.settings.after_label }}
          </span>
        {% endif %}
      </div>

      {%- comment -%} Before Image (slider overlay) {%- endcomment -%}
      <div class="comparison-slider__before" data-before-container style="width: 50%;">
        {% if section.settings.before_image != blank %}
          {{ section.settings.before_image | image_url: width: 1600 | image_tag:
            class: 'tw-w-full tw-h-auto tw-block',
            loading: 'lazy',
            alt: section.settings.before_label | default: 'Before'
          }}
        {% else %}
          {{ 'lifestyle-1' | placeholder_svg_tag: 'tw-w-full tw-h-auto tw-block tw-bg-velox-200' }}
        {% endif %}
        {% if section.settings.before_label != blank %}
          <span class="comparison-slider__label comparison-slider__label--before">
            {{ section.settings.before_label }}
          </span>
        {% endif %}
      </div>

      {%- comment -%} Slider Handle {%- endcomment -%}
      <div class="comparison-slider__handle" data-slider-handle>
        <div class="comparison-slider__handle-line"></div>
        <div class="comparison-slider__handle-button">
          <svg class="tw-w-6 tw-h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l4-4 4 4m0 6l-4 4-4-4"/>
          </svg>
        </div>
        <div class="comparison-slider__handle-line"></div>
      </div>
    </div>

    {%- comment -%} Caption {%- endcomment -%}
    {% if section.settings.caption != blank %}
      <p class="tw-text-center tw-text-velox-600 tw-mt-6 tw-text-sm">
        {{ section.settings.caption }}
      </p>
    {% endif %}
  </div>
</section>

<script>
(function() {
  const sliders = document.querySelectorAll('[data-comparison-slider]');
  
  sliders.forEach(slider => {
    const handle = slider.querySelector('[data-slider-handle]');
    const before = slider.querySelector('[data-before-container]');
    
    if (!handle || !before) return;

    let isDragging = false;

    function updateSlider(x) {
      const rect = slider.getBoundingClientRect();
      const position = Math.max(0, Math.min(x - rect.left, rect.width));
      const percentage = (position / rect.width) * 100;
      
      before.style.width = `${percentage}%`;
      handle.style.left = `${percentage}%`;
    }

    // Mouse events
    handle.addEventListener('mousedown', (e) => {
      e.preventDefault();
      isDragging = true;
      slider.classList.add('is-dragging');
    });

    document.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      updateSlider(e.clientX);
    });

    document.addEventListener('mouseup', () => {
      isDragging = false;
      slider.classList.remove('is-dragging');
    });

    // Touch events
    handle.addEventListener('touchstart', (e) => {
      isDragging = true;
      slider.classList.add('is-dragging');
    }, { passive: true });

    document.addEventListener('touchmove', (e) => {
      if (!isDragging) return;
      updateSlider(e.touches[0].clientX);
    }, { passive: true });

    document.addEventListener('touchend', () => {
      isDragging = false;
      slider.classList.remove('is-dragging');
    });

    // Click to jump
    slider.addEventListener('click', (e) => {
      if (e.target === handle || handle.contains(e.target)) return;
      updateSlider(e.clientX);
    });

    // Keyboard accessibility
    handle.setAttribute('tabindex', '0');
    handle.setAttribute('role', 'slider');
    handle.setAttribute('aria-label', 'Comparison slider');
    handle.setAttribute('aria-valuemin', '0');
    handle.setAttribute('aria-valuemax', '100');
    handle.setAttribute('aria-valuenow', '50');

    handle.addEventListener('keydown', (e) => {
      const currentPercent = parseFloat(before.style.width) || 50;
      let newPercent = currentPercent;

      if (e.key === 'ArrowLeft' || e.key === 'ArrowDown') {
        newPercent = Math.max(0, currentPercent - 5);
      } else if (e.key === 'ArrowRight' || e.key === 'ArrowUp') {
        newPercent = Math.min(100, currentPercent + 5);
      }

      if (newPercent !== currentPercent) {
        before.style.width = `${newPercent}%`;
        handle.style.left = `${newPercent}%`;
        handle.setAttribute('aria-valuenow', Math.round(newPercent));
      }
    });
  });
})();
</script>

{% schema %}
{
  "name": "Comparison Slider",
  "tag": "section",
  "class": "comparison-slider-section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "See the Difference"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading"
    },
    {
      "type": "header",
      "content": "Before Image"
    },
    {
      "type": "image_picker",
      "id": "before_image",
      "label": "Before image"
    },
    {
      "type": "text",
      "id": "before_label",
      "label": "Before label",
      "default": "Before"
    },
    {
      "type": "header",
      "content": "After Image"
    },
    {
      "type": "image_picker",
      "id": "after_image",
      "label": "After image"
    },
    {
      "type": "text",
      "id": "after_label",
      "label": "After label",
      "default": "After"
    },
    {
      "type": "header",
      "content": "Settings"
    },
    {
      "type": "range",
      "id": "max_width",
      "min": 600,
      "max": 1200,
      "step": 50,
      "default": 900,
      "unit": "px",
      "label": "Maximum width"
    },
    {
      "type": "textarea",
      "id": "caption",
      "label": "Caption (optional)"
    }
  ],
  "presets": [
    {
      "name": "Comparison slider",
      "category": "Image",
      "settings": {
        "heading": "See the difference",
        "subheading": "Before & After",
        "before_label": "Before",
        "after_label": "After",
        "max_width": 900,
        "caption": "Drag the slider to compare the before and after results."
      }
    }
  ]
}
{% endschema %}
