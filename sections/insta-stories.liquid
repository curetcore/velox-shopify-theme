{% comment %}
  Velox Insta Stories
  UI tipo Instagram Stories con avatares circulares.
  Cada story puede contener imagen o video.
{% endcomment %}

<section
  class="insta-stories-section tw-py-8 lg:tw-py-12"
  data-section-id="{{ section.id }}"
  data-animate="fade-up"
>
  <div class="tw-max-w-7xl tw-mx-auto tw-px-4">
    {%- comment -%} Header {%- endcomment -%}
    {% if section.settings.heading != blank %}
      <div class="tw-mb-6">
        <h2 class="tw-text-xl lg:tw-text-2xl tw-font-bold tw-text-velox-900">
          {{ section.settings.heading }}
        </h2>
      </div>
    {% endif %}

    {%- comment -%} Stories Container {%- endcomment -%}
    <insta-stories class="tw-block">
      {%- comment -%} Stories Scroll Container {%- endcomment -%}
      <div class="tw-flex tw-gap-4 tw-overflow-x-auto tw-pb-4 tw-scrollbar-hide" data-stories-container>
        {% for block in section.blocks %}
          {% if block.type == 'story' %}
            <button
              type="button"
              class="tw-flex-shrink-0 tw-group tw-cursor-pointer tw-text-center tw-bg-transparent tw-border-0 tw-p-0"
              data-story-trigger="{{ forloop.index0 }}"
              aria-label="{{ 'sections.stories.view_story' | t }}"
              {{ block.shopify_attributes }}
            >
              {%- comment -%} Avatar Ring {%- endcomment -%}
              <div class="tw-relative tw-w-16 tw-h-16 lg:tw-w-20 lg:tw-h-20 tw-mx-auto tw-mb-2">
                {%- comment -%} Gradient Ring {%- endcomment -%}
                <div class="tw-absolute tw-inset-0 tw-rounded-full tw-p-0.5
                  {% if block.settings.is_seen %}
                    tw-bg-velox-300
                  {% else %}
                    tw-bg-gradient-to-tr tw-from-yellow-400 tw-via-red-500 tw-to-purple-600
                  {% endif %}
                ">
                  <div class="tw-w-full tw-h-full tw-rounded-full tw-bg-white tw-p-0.5">
                    {% if block.settings.avatar != blank %}
                      {{ block.settings.avatar | image_url: width: 160 | image_tag:
                        class: 'tw-w-full tw-h-full tw-rounded-full tw-object-cover group-hover:tw-scale-105 tw-transition-transform',
                        loading: 'lazy',
                        alt: block.settings.title
                      }}
                    {% else %}
                      <div class="tw-w-full tw-h-full tw-rounded-full tw-bg-velox-200 tw-flex tw-items-center tw-justify-center">
                        <svg class="tw-w-6 tw-h-6 tw-text-velox-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
              {%- comment -%} Title {%- endcomment -%}
              {% if block.settings.title != blank %}
                <span class="tw-text-xs tw-text-velox-700 tw-truncate tw-block tw-max-w-[72px] lg:tw-max-w-[88px]">
                  {{ block.settings.title }}
                </span>
              {% endif %}
            </button>
          {% endif %}
        {% endfor %}
      </div>

      {%- comment -%} Story Modal {%- endcomment -%}
      <div
        class="tw-fixed tw-inset-0 tw-z-50 tw-bg-black tw-opacity-0 tw-invisible tw-transition-opacity tw-duration-300"
        data-story-modal
        role="dialog"
        aria-modal="true"
        aria-label="{{ 'sections.stories.view_story' | t }}"
      >
        {%- comment -%} Modal Content {%- endcomment -%}
        <div class="tw-relative tw-w-full tw-h-full tw-flex tw-items-center tw-justify-center">
          {%- comment -%} Close Button {%- endcomment -%}
          <button
            type="button"
            class="tw-absolute tw-top-4 tw-right-4 tw-z-10 tw-w-10 tw-h-10 tw-rounded-full tw-bg-white/20 hover:tw-bg-white/30 tw-flex tw-items-center tw-justify-center tw-transition-colors"
            data-story-close
            aria-label="{{ 'sections.stories.close' | t }}"
          >
            <svg class="tw-w-6 tw-h-6 tw-text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>

          {%- comment -%} Navigation Arrows {%- endcomment -%}
          <button
            type="button"
            class="tw-absolute tw-left-4 tw-top-1/2 tw--translate-y-1/2 tw-z-10 tw-w-10 tw-h-10 tw-rounded-full tw-bg-white/20 hover:tw-bg-white/30 tw-flex tw-items-center tw-justify-center tw-transition-colors tw-opacity-0 tw-invisible"
            data-story-prev
            aria-label="{{ 'sections.stories.previous' | t }}"
          >
            <svg class="tw-w-6 tw-h-6 tw-text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
          </button>

          <button
            type="button"
            class="tw-absolute tw-right-4 tw-top-1/2 tw--translate-y-1/2 tw-z-10 tw-w-10 tw-h-10 tw-rounded-full tw-bg-white/20 hover:tw-bg-white/30 tw-flex tw-items-center tw-justify-center tw-transition-colors tw-opacity-0 tw-invisible"
            data-story-next
            aria-label="{{ 'sections.stories.next' | t }}"
          >
            <svg class="tw-w-6 tw-h-6 tw-text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </button>

          {%- comment -%} Story Content Container {%- endcomment -%}
          <div
            class="tw-relative tw-w-full tw-max-w-sm tw-h-[80vh] tw-max-h-[700px] tw-bg-velox-950 tw-rounded-xl tw-overflow-hidden"
            data-story-content
          >
            {%- comment -%} Progress Bars {%- endcomment -%}
            <div class="tw-absolute tw-top-0 tw-left-0 tw-right-0 tw-z-10 tw-p-2 tw-flex tw-gap-1" data-story-progress>
              {% for block in section.blocks %}
                {% if block.type == 'story' %}
                  <div class="tw-flex-1 tw-h-0.5 tw-bg-white/30 tw-rounded-full tw-overflow-hidden">
                    <div
                      class="tw-h-full tw-bg-white tw-w-0 tw-transition-all"
                      data-progress-bar="{{ forloop.index0 }}"
                    ></div>
                  </div>
                {% endif %}
              {% endfor %}
            </div>

            {%- comment -%} Story Header {%- endcomment -%}
            <div class="tw-absolute tw-top-4 tw-left-0 tw-right-0 tw-z-10 tw-px-4 tw-pt-4" data-story-header>
              {% for block in section.blocks %}
                {% if block.type == 'story' %}
                  <div
                    class="tw-flex tw-items-center tw-gap-3 tw-hidden"
                    data-story-info="{{ forloop.index0 }}"
                  >
                    <div class="tw-w-8 tw-h-8 tw-rounded-full tw-overflow-hidden tw-border-2 tw-border-white">
                      {% if block.settings.avatar != blank %}
                        {{ block.settings.avatar | image_url: width: 64 | image_tag:
                          class: 'tw-w-full tw-h-full tw-object-cover',
                          loading: 'lazy',
                          alt: block.settings.title
                        }}
                      {% else %}
                        <div class="tw-w-full tw-h-full tw-bg-velox-300"></div>
                      {% endif %}
                    </div>
                    <span class="tw-text-white tw-text-sm tw-font-medium">{{ block.settings.title }}</span>
                  </div>
                {% endif %}
              {% endfor %}
            </div>

            {%- comment -%} Story Slides {%- endcomment -%}
            {% for block in section.blocks %}
              {% if block.type == 'story' %}
                <div
                  class="tw-absolute tw-inset-0 tw-hidden tw-flex-col"
                  data-story-slide="{{ forloop.index0 }}"
                >
                  {%- comment -%} Media {%- endcomment -%}
                  {% if block.settings.video_url != blank %}
                    <video
                      class="tw-w-full tw-h-full tw-object-cover"
                      data-story-video
                      playsinline
                      muted
                      loop
                    >
                      <source src="{{ block.settings.video_url }}" type="video/mp4">
                    </video>
                  {% elsif block.settings.image != blank %}
                    {{ block.settings.image | image_url: width: 800 | image_tag:
                      class: 'tw-w-full tw-h-full tw-object-cover',
                      loading: 'lazy',
                      alt: block.settings.title
                    }}
                  {% else %}
                    {{ 'lifestyle-1' | placeholder_svg_tag: 'tw-w-full tw-h-full tw-object-cover tw-bg-velox-800' }}
                  {% endif %}

                  {%- comment -%} Overlay Content {%- endcomment -%}
                  {% if block.settings.caption != blank or block.settings.link_text != blank %}
                    <div class="tw-absolute tw-bottom-0 tw-left-0 tw-right-0 tw-p-6 tw-bg-gradient-to-t tw-from-black/80 tw-to-transparent">
                      {% if block.settings.caption != blank %}
                        <p class="tw-text-white tw-text-sm tw-mb-3">
                          {{ block.settings.caption }}
                        </p>
                      {% endif %}
                      {% if block.settings.link_text != blank and block.settings.link_url != blank %}
                        <a
                          href="{{ block.settings.link_url }}"
                          class="tw-inline-flex tw-items-center tw-gap-2 tw-px-4 tw-py-2 tw-bg-white tw-text-velox-900 tw-text-sm tw-font-medium tw-rounded-full hover:tw-bg-velox-100 tw-transition-colors"
                        >
                          {{ block.settings.link_text }}
                          <svg class="tw-w-4 tw-h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14m-7-7l7 7-7 7"/>
                          </svg>
                        </a>
                      {% endif %}
                    </div>
                  {% endif %}
                </div>
              {% endif %}
            {% endfor %}

            {%- comment -%} Click Areas for Navigation {%- endcomment -%}
            <div class="tw-absolute tw-inset-0 tw-flex">
              <div class="tw-w-1/3 tw-h-full tw-cursor-pointer" data-story-tap-prev></div>
              <div class="tw-w-1/3 tw-h-full"></div>
              <div class="tw-w-1/3 tw-h-full tw-cursor-pointer" data-story-tap-next></div>
            </div>
          </div>
        </div>
      </div>
    </insta-stories>
  </div>
</section>

<style>
  .tw-scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .tw-scrollbar-hide::-webkit-scrollbar {
    display: none;
  }

  [data-story-modal].is-active {
    opacity: 1;
    visibility: visible;
  }

  [data-story-prev].is-visible,
  [data-story-next].is-visible {
    opacity: 1;
    visibility: visible;
  }

  [data-story-slide].is-active {
    display: flex;
  }

  [data-story-info].is-active {
    display: flex;
  }

  @media (prefers-reduced-motion: reduce) {
    [data-progress-bar] {
      transition: none;
    }
  }
</style>

<script>
(function() {
  class InstaStories extends HTMLElement {
    constructor() {
      super();
      this.modal = this.querySelector('[data-story-modal]');
      this.triggers = this.querySelectorAll('[data-story-trigger]');
      this.slides = this.querySelectorAll('[data-story-slide]');
      this.progressBars = this.querySelectorAll('[data-progress-bar]');
      this.infos = this.querySelectorAll('[data-story-info]');
      this.closeBtn = this.querySelector('[data-story-close]');
      this.prevBtn = this.querySelector('[data-story-prev]');
      this.nextBtn = this.querySelector('[data-story-next]');
      this.tapPrev = this.querySelector('[data-story-tap-prev]');
      this.tapNext = this.querySelector('[data-story-tap-next]');

      this.currentIndex = 0;
      this.totalStories = this.slides.length;
      this.progressInterval = null;
      this.storyDuration = {{ section.settings.story_duration | default: 5 }} * 1000;
    }

    connectedCallback() {
      this.setupTriggers();
      this.setupNavigation();
      this.setupKeyboard();
    }

    setupTriggers() {
      this.triggers.forEach(trigger => {
        trigger.addEventListener('click', () => {
          const index = parseInt(trigger.dataset.storyTrigger);
          this.openStory(index);
        });
      });
    }

    setupNavigation() {
      this.closeBtn?.addEventListener('click', () => this.closeModal());
      this.prevBtn?.addEventListener('click', () => this.prevStory());
      this.nextBtn?.addEventListener('click', () => this.nextStory());
      this.tapPrev?.addEventListener('click', () => this.prevStory());
      this.tapNext?.addEventListener('click', () => this.nextStory());

      // Cierre con click fuera
      this.modal?.addEventListener('click', (e) => {
        if (e.target === this.modal || e.target.closest('[data-story-content]') === null) {
          this.closeModal();
        }
      });
    }

    setupKeyboard() {
      document.addEventListener('keydown', (e) => {
        if (!this.modal?.classList.contains('is-active')) return;

        switch (e.key) {
          case 'Escape':
            this.closeModal();
            break;
          case 'ArrowLeft':
            this.prevStory();
            break;
          case 'ArrowRight':
            this.nextStory();
            break;
        }
      });
    }

    openStory(index) {
      this.currentIndex = index;
      this.modal.classList.add('is-active');
      document.body.style.overflow = 'hidden';
      this.showStory(index);
      this.updateNavButtons();
    }

    closeModal() {
      this.modal.classList.remove('is-active');
      document.body.style.overflow = '';
      this.stopProgress();
      this.pauseAllVideos();
    }

    showStory(index) {
      // Ocultar todas
      this.slides.forEach(slide => slide.classList.remove('is-active'));
      this.infos.forEach(info => info.classList.remove('is-active'));

      // Mostrar actual
      const slide = this.slides[index];
      const info = this.infos[index];
      if (slide) slide.classList.add('is-active');
      if (info) info.classList.add('is-active');

      // Reset barras anteriores y avanzar completadas
      this.progressBars.forEach((bar, i) => {
        if (i < index) {
          bar.style.width = '100%';
        } else {
          bar.style.width = '0%';
        }
      });

      // Reproducir video si existe
      this.pauseAllVideos();
      const video = slide?.querySelector('[data-story-video]');
      if (video) {
        video.currentTime = 0;
        video.play();
      }

      // Iniciar progreso
      this.startProgress(index);
    }

    startProgress(index) {
      this.stopProgress();

      const bar = this.progressBars[index];
      if (!bar) return;

      let progress = 0;
      const increment = 100 / (this.storyDuration / 50);

      this.progressInterval = setInterval(() => {
        progress += increment;
        bar.style.width = `${Math.min(progress, 100)}%`;

        if (progress >= 100) {
          this.nextStory();
        }
      }, 50);
    }

    stopProgress() {
      if (this.progressInterval) {
        clearInterval(this.progressInterval);
        this.progressInterval = null;
      }
    }

    prevStory() {
      if (this.currentIndex > 0) {
        this.currentIndex--;
        this.showStory(this.currentIndex);
        this.updateNavButtons();
      }
    }

    nextStory() {
      if (this.currentIndex < this.totalStories - 1) {
        this.currentIndex++;
        this.showStory(this.currentIndex);
        this.updateNavButtons();
      } else {
        this.closeModal();
      }
    }

    updateNavButtons() {
      // Mostrar/ocultar botones según posición
      if (this.prevBtn) {
        this.prevBtn.classList.toggle('is-visible', this.currentIndex > 0);
      }
      if (this.nextBtn) {
        this.nextBtn.classList.toggle('is-visible', this.currentIndex < this.totalStories - 1);
      }
    }

    pauseAllVideos() {
      this.querySelectorAll('[data-story-video]').forEach(video => {
        video.pause();
      });
    }
  }

  if (!customElements.get('insta-stories')) {
    customElements.define('insta-stories', InstaStories);
  }
})();
</script>

{% schema %}
{
  "name": "Insta Stories",
  "tag": "section",
  "class": "insta-stories-section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Stories"
    },
    {
      "type": "range",
      "id": "story_duration",
      "min": 3,
      "max": 15,
      "step": 1,
      "default": 5,
      "unit": "s",
      "label": "Story duration",
      "info": "Time for each story before auto-advance"
    }
  ],
  "blocks": [
    {
      "type": "story",
      "name": "Story",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Title",
          "default": "Story"
        },
        {
          "type": "image_picker",
          "id": "avatar",
          "label": "Avatar image"
        },
        {
          "type": "checkbox",
          "id": "is_seen",
          "label": "Mark as seen",
          "info": "Show gray ring instead of gradient",
          "default": false
        },
        {
          "type": "header",
          "content": "Story Content"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Story image"
        },
        {
          "type": "url",
          "id": "video_url",
          "label": "Video URL (optional)",
          "info": "Direct link to MP4 video"
        },
        {
          "type": "textarea",
          "id": "caption",
          "label": "Caption"
        },
        {
          "type": "text",
          "id": "link_text",
          "label": "Link text"
        },
        {
          "type": "url",
          "id": "link_url",
          "label": "Link URL"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Insta Stories",
      "settings": {
        "heading": "Stories"
      },
      "blocks": [
        {
          "type": "story",
          "settings": {
            "title": "New Arrival"
          }
        },
        {
          "type": "story",
          "settings": {
            "title": "Behind the Scenes"
          }
        },
        {
          "type": "story",
          "settings": {
            "title": "Sale Alert"
          }
        }
      ]
    }
  ]
}
{% endschema %}
