{% comment %}
  Velox Related Products Section

  Muestra productos relacionados usando la API de recomendaciones de Shopify
  o productos de la misma colección como fallback.
{% endcomment %}

{%- liquid
  assign product_ref = product | default: section.settings.product
  assign heading = section.settings.heading
  assign products_to_show = section.settings.products_to_show
  assign columns_desktop = section.settings.columns_desktop
  assign columns_mobile = section.settings.columns_mobile
  assign show_vendor = section.settings.show_vendor
  assign show_quick_view = section.settings.show_quick_view

  # Configuración de grid responsive
  case columns_desktop
    when 2
      assign grid_class = 'lg:tw-grid-cols-2'
    when 3
      assign grid_class = 'lg:tw-grid-cols-3'
    when 5
      assign grid_class = 'lg:tw-grid-cols-5'
    when 6
      assign grid_class = 'lg:tw-grid-cols-6'
    else
      assign grid_class = 'lg:tw-grid-cols-4'
  endcase

  case columns_mobile
    when 1
      assign mobile_grid_class = 'tw-grid-cols-1'
    else
      assign mobile_grid_class = 'tw-grid-cols-2'
  endcase
-%}

<section class="tw-py-16 sm:tw-py-24 tw-bg-white" {{ section.shopify_attributes }}>
  <div class="tw-mx-auto tw-max-w-7xl tw-px-4 sm:tw-px-6 lg:tw-px-8">
    {%- comment -%} Header {%- endcomment -%}
    {% if heading != blank %}
      <div class="tw-flex tw-items-center tw-justify-between tw-mb-8">
        <h2 class="tw-text-2xl tw-font-bold tw-tracking-tight tw-text-velox-900">
          {{ heading }}
        </h2>
        {% if section.settings.show_view_all and product_ref.collections.first %}
          <a
            href="{{ product_ref.collections.first.url }}"
            class="tw-text-sm tw-font-medium tw-text-velox-accent hover:tw-text-velox-accent/80 tw-transition-colors tw-flex tw-items-center tw-gap-1"
          >
            {{ 'collections.general.view_all' | t | default: 'Ver todos' }}
            {% render 'icon', name: 'arrow-right', class: 'tw-w-4 tw-h-4' %}
          </a>
        {% endif %}
      </div>
    {% endif %}

    {%- comment -%} Grid de productos relacionados {%- endcomment -%}
    <div
      id="RelatedProducts-{{ section.id }}"
      class="tw-grid {{ mobile_grid_class }} md:tw-grid-cols-3 {{ grid_class }} tw-gap-x-6 tw-gap-y-10"
      data-related-products
      data-product-id="{{ product_ref.id }}"
      data-limit="{{ products_to_show }}"
    >
      {%- comment -%} Productos de placeholder para editor de tema {%- endcomment -%}
      {% if product_ref == blank %}
        {% for i in (1..products_to_show) %}
          <article class="tw-product-card tw-group tw-relative">
            <div class="tw-aspect-product tw-w-full tw-bg-velox-100 tw-rounded-lg tw-animate-pulse"></div>
            <div class="tw-mt-4 tw-space-y-2">
              <div class="tw-h-4 tw-bg-velox-100 tw-rounded tw-w-3/4"></div>
              <div class="tw-h-4 tw-bg-velox-100 tw-rounded tw-w-1/2"></div>
            </div>
          </article>
        {% endfor %}
      {% else %}
        {%- comment -%} Productos de la misma colección como fallback inicial {%- endcomment -%}
        {% assign related_products = product_ref.collections.first.products | where: 'available' %}
        {% for related_product in related_products limit: products_to_show %}
          {% unless related_product.id == product_ref.id %}
            {% render 'product-card',
              product: related_product,
              show_vendor: show_vendor,
              show_quick_view: show_quick_view
            %}
          {% endunless %}
        {% endfor %}
      {% endif %}
    </div>

    {%- comment -%} Loading state para AJAX {%- endcomment -%}
    <div class="tw-hidden tw-text-center tw-py-8" data-related-loading>
      <div class="tw-inline-flex tw-items-center tw-gap-2 tw-text-velox-600">
        {% render 'icon', name: 'spinner', class: 'tw-w-5 tw-h-5 tw-animate-spin' %}
        {{ 'general.accessibility.loading' | t }}
      </div>
    </div>
  </div>
</section>

{%- comment -%} JavaScript para cargar recomendaciones via API {%- endcomment -%}
<script>
  (function() {
    const section = document.getElementById('RelatedProducts-{{ section.id }}');
    if (!section) return;

    const productId = section.dataset.productId;
    const limit = parseInt(section.dataset.limit) || 4;

    // Solo cargar via API si estamos en una página de producto
    if (!productId || productId === '') return;

    // Usar la API de recomendaciones de Shopify
    const url = `/recommendations/products.json?product_id=${productId}&limit=${limit}&intent=related`;

    fetch(url)
      .then(response => response.json())
      .then(data => {
        if (data.products && data.products.length > 0) {
          // Recargar la sección con los productos recomendados
          const sectionUrl = `${window.location.pathname}?section_id={{ section.id }}&product_id=${productId}`;

          fetch(sectionUrl)
            .then(response => response.text())
            .then(html => {
              const parser = new DOMParser();
              const doc = parser.parseFromString(html, 'text/html');
              const newSection = doc.getElementById('RelatedProducts-{{ section.id }}');
              if (newSection) {
                section.innerHTML = newSection.innerHTML;
              }
            })
            .catch(err => console.log('Error loading section:', err));
        }
      })
      .catch(err => console.log('Error fetching recommendations:', err));
  })();
</script>

{% schema %}
{
  "name": "Productos relacionados",
  "tag": "section",
  "class": "section-related-products",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Titulo",
      "default": "También te puede interesar"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "label": "Productos a mostrar",
      "min": 2,
      "max": 12,
      "step": 1,
      "default": 4
    },
    {
      "type": "select",
      "id": "columns_desktop",
      "label": "Columnas en desktop",
      "options": [
        { "value": "2", "label": "2 columnas" },
        { "value": "3", "label": "3 columnas" },
        { "value": "4", "label": "4 columnas" },
        { "value": "5", "label": "5 columnas" },
        { "value": "6", "label": "6 columnas" }
      ],
      "default": "4"
    },
    {
      "type": "select",
      "id": "columns_mobile",
      "label": "Columnas en movil",
      "options": [
        { "value": "1", "label": "1 columna" },
        { "value": "2", "label": "2 columnas" }
      ],
      "default": "2"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "label": "Mostrar marca",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_quick_view",
      "label": "Mostrar boton de vista rapida",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_view_all",
      "label": "Mostrar enlace 'Ver todos'",
      "default": true
    },
    {
      "type": "header",
      "content": "Espaciado"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding superior",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding inferior",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 36
    }
  ],
  "presets": [
    {
      "name": "Productos relacionados",
      "settings": {
        "heading": "También te puede interesar",
        "products_to_show": 4,
        "columns_desktop": "4",
        "columns_mobile": "2"
      }
    }
  ]
}
{% endschema %}
